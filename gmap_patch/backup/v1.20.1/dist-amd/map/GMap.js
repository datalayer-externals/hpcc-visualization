!function(e,t){"function"==typeof define&&define.amd?define(["d3","../common/HTMLWidget","../layout/AbsoluteSurface","css!./GMap"],t):e.map_GMap=t(e.d3,e.common_HTMLWidget,e.layout_AbsoluteSurface)}(this,function(e,t,o){function i(e,t,o){function i(e,t,o){google.maps.OverlayView.call(this),this._div=null,this._worldSurface=t,this._viewportSurface=o,this._map=e,this.setMap(e);var i=this;google.maps.event.addListener(e,"bounds_changed",function(){i.draw()}),google.maps.event.addListener(e,"projection_changed",function(){i.draw()}),this._prevWorldMin={x:0,y:0},this._prevWorldMax={x:0,y:0},this._prevMin={x:0,y:0},this._prevMax={x:0,y:0}}return i.prototype=google.maps.OverlayView.prototype,i.prototype.onAdd=function(){this.div=document.createElement("div"),this._viewportSurface.target(this.div).units("pixels");var e=this.getPanes();e.overlayMouseTarget.appendChild(this.div)},i.prototype.draw=function(){var e=this.getProjection();if(e){for(var t=this._map.getBounds(),o=e.fromLatLngToDivPixel(t.getCenter()),i=e.fromLatLngToDivPixel(t.getSouthWest()),r=e.fromLatLngToDivPixel(t.getNorthEast()),a={x:i.x,y:r.y},n={x:r.x,y:i.y},s=e.getWorldWidth();n.x<a.x+100;)n.x+=s;for(;a.x>o.x;)a.x-=s,n.x-=s;(a.x!==this._prevMin.x||a.y!==this._prevMin.y||n.x!==this._prevMax.x||n.y!==this._prevMax.y)&&(this._viewportSurface.widgetX(a.x).widgetY(a.y).widgetWidth(n.x-a.x).widgetHeight(n.y-a.y),this._viewportSurface._renderCount?(this._viewportSurface.render(),this._prevMin=a,this._prevMax=n):this._viewportSurface.lazyRender());for(var l=e.fromLatLngToDivPixel(new google.maps.LatLng(85,-179.9)),p=e.fromLatLngToDivPixel(new google.maps.LatLng(-85,179.9));p.x<l.x+100;)p.x+=s;for(;l.x>o.x;)l.x-=s,p.x-=s;(l.x!==this._prevWorldMin.x||l.y!==this._prevWorldMin.y||p.x!==this._prevWorldMax.x||p.y!==this._prevWorldMax.y)&&(this._worldSurface.widgetX(l.x).widgetY(l.y).widgetWidth(p.x-l.x).widgetHeight(p.y-l.y).render(),this._prevWorldMin=p,this._prevWorldMax=p)}},i.prototype.onRemove=function(){this._viewportSurface.target(null),this._div.parentNode.removeChild(this._div),this._div=null},new i(e,t,o)}function r(e){this._userShapes=[],this.mapContext=e}function a(){function e(e,t,o){var r=i._overlay.getProjection(),a=r.fromLatLngToDivPixel(new google.maps.LatLng(t,o)),n=r.getWorldWidth(),s=parseFloat(e.widgetX()),l=parseFloat(e.widgetY()),p=parseFloat(e.widgetWidth());for(a.x-=s,a.y-=l;a.x<0;)a.x+=n;for(;a.x>p;)a.x-=n;return a}t.call(this),this._tag="div";var i=this;this._userShapes=new r(this),this._worldSurface=new o,this._worldSurface.project=function(t,o){return e(this,t,o)},this._viewportSurface=new o,this._viewportSurface.project=function(t,o){return e(this,t,o)}}return r.prototype.add=function(e){var t=this._userShapes.indexOf(e);t>=0||this._userShapes.push(e)},r.prototype.remove=function(e){var t=this._userShapes.indexOf(e);t>=0&&this._userShapes.splice(t,1),e.setMap(null)},r.prototype.save=function(){return this._userShapes.map(function(e){return r.prototype._saveShape(e)})},r.prototype.load=function(e){this._deserializeShapes(e)},r.prototype._saveShape=function(e){var t={},o={circle:function(e){t.type="circle",t.pos={lat:e.center.lat(),lng:e.center.lng()},t.radius=e.radius},rectangle:function(e){t.type="rectangle",t.bounds={ne:e.bounds.getNorthEast(),sw:e.bounds.getSouthWest()}},polygon:function(e){t.type=e.__hpcc_type;var o=e.getPath();t.vertices=[];for(var i=0;i<o.length;i++)t.vertices.push(o.getAt(i))},polyline:function(e){o.polygon(e)}};return o[e.__hpcc_type](e),t.strokeWeight=e.strokeWeight,t.fillColor=e.fillColor,t.fillOpacity=e.fillOpacity,t.editable=e.editable,t.clickable=e.clickable||!0,t},r.prototype._deserializeShapes=function(e){for(var t=JSON.parse(e),o={strokeWeight:0,fillOpacity:.45,fillColor:"#1f77b4",editable:!0,clickable:!0},i={circle:function(e,t){var i=new google.maps.Circle({strokeWeight:e.strokeWeight||o.strokeWeight,fillColor:e.fillColor||o.fillColor,fillOpacity:e.fillOpacity||o.fillOpacity,editable:e.editable||o.editable,clickable:e.clickable||o.clickable,map:t,center:e.pos,radius:e.radius});return i},rectangle:function(e,t){var i=new google.maps.Rectangle({strokeWeight:e.strokeWeight||o.strokeWeight,fillColor:e.fillColor||o.fillColor,fillOpacity:e.fillOpacity||o.fillOpacity,editable:e.editable||o.editable,clickable:e.clickable||o.clickable,map:t,bounds:{north:e.bounds.ne.lat,west:e.bounds.sw.lng,south:e.bounds.sw.lat,east:e.bounds.ne.lng}});return i},polygon:function(e,t){var i=new google.maps.Polygon({strokeWeight:e.strokeWeight||o.strokeWeight,fillColor:e.fillColor||o.fillColor,fillOpacity:e.fillOpacity||o.fillOpacity,editable:e.editable||o.editable,clickable:e.clickable||o.clickable,map:t,paths:e.vertices});return i},polyline:function(e,t){var i=new google.maps.Polyline({strokeWeight:e.strokeWeight||o.strokeWeight,fillColor:e.fillColor||o.fillColor,fillOpacity:e.fillOpacity||o.fillOpacity,editable:e.editable||o.editable,clickable:e.clickable||o.clickable,map:t,path:e.vertices});return i}},r=0;r<t.length;r++){var a=i[t[r].type](t[r],this.mapContext._googleMap);this.mapContext.onDrawingComplete({type:t[r].type,overlay:a})}},a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype._class+=" map_GMap",a.prototype.publish("type","road","set","Map Type",["terrain","road","satellite","hybrid"],{tags:["Basic"]}),a.prototype.publish("centerLat",42.877742,"number","Center Latitude",null,{tags:["Basic"]}),a.prototype.publish("centerLong",-97.380979,"number","Center Longtitude",null,{tags:["Basic"]}),a.prototype.publish("centerAddress",null,"string","Address to center map on",null,{tags:["Basic"],optional:!0}),a.prototype.publish("zoom",4,"number","Zoom Level",null,{tags:["Basic"]}),a.prototype.publish("singleZoomToMaxZoom",14,"number","Max zoomTo level with single item"),a.prototype.publish("panControl",!0,"boolean","Pan Controls",null,{tags:["Basic"]}),a.prototype.publish("zoomControl",!0,"boolean","Zoom Controls",null,{tags:["Basic"]}),a.prototype.publish("scaleControl",!0,"boolean","Scale Controls",null,{tags:["Basic"]}),a.prototype.publish("mapTypeControl",!1,"boolean","Map Type Controls",null,{tags:["Basic"]}),a.prototype.publish("fullscreenControl",!1,"boolean","Fullscreen Controls",null,{tags:["Basic"]}),a.prototype.publish("streetViewControl",!1,"boolean","StreetView Controls",null,{tags:["Basic"]}),a.prototype.publish("overviewMapControl",!1,"boolean","OverviewMap Controls",null,{tags:["Basic"]}),a.prototype.publish("streetView",!1,"boolean","Streetview",null,{tags:["Basic"]}),a.prototype.publish("drawingTools",!1,"boolean","Drawing Tools",null,{tags:["Basic"]}),a.prototype.publish("drawingState","","string","Map Drawings",null,{disabel:function(e){return e.drawingTools()===!1}}),a.prototype.publish("googleMapStyles",{},"object","Styling for map colors etc",null,{tags:["Basic"]}),a.prototype.data=function(e){var o=t.prototype.data.apply(this,arguments);return o},a.prototype.getMapType=function(){switch(this.type()){case"terrain":return google.maps.MapTypeId.TERRAIN;case"road":return google.maps.MapTypeId.ROADMAP;case"satellite":return google.maps.MapTypeId.SATELLITE;case"hybrid":return google.maps.MapTypeId.HYBRID;default:return google.maps.MapTypeId.ROADMAP}},a.prototype.getMapOptions=function(){return{panControl:this.panControl(),zoomControl:this.zoomControl(),fullscreenControl:this.fullscreenControl(),mapTypeControl:this.mapTypeControl(),scaleControl:this.scaleControl(),streetViewControl:this.streetViewControl(),overviewMapControl:this.overviewMapControl(),overviewMapControlOptions:{opened:!0},styles:this.googleMapStyles()}},a.prototype.size=function(e){var o=t.prototype.size.apply(this,arguments);return arguments.length&&this._googleMapNode&&(this._googleMapNode.style({width:e.width+"px",height:e.height+"px"}),google.maps.event.trigger(this._googleMap,"resize")),o},a.prototype.enter=function(o,r){t.prototype.enter.apply(this,arguments);var a=this;this._googleGeocoder=new google.maps.Geocoder,this._googleMapNode=r.append("div").style({width:this.width()+"px",height:this.height()+"px"}),this._googleMap=new google.maps.Map(this._googleMapNode.node(),{zoom:this.zoom(),center:new google.maps.LatLng(this.centerLat(),this.centerLong()),mapTypeId:this.getMapType(),disableDefaultUI:!0}),this._overlay=i(this._googleMap,this._worldSurface,this._viewportSurface),this._googleMap.addListener("center_changed",function(){a.centerLat(a._googleMap.center.lat()),a._prevCenterLat=a.centerLat(),a.centerLong(a._googleMap.center.lng()),a._prevCenterLong=a.centerLong(),a._googleMapPanorama.setPosition({lat:a.centerLat(),lng:a.centerLong()}),a.zoom(a._googleMap.getZoom()),a._prevZoom=a.zoom()}),this._googleMap.addListener("zoom_changed",function(){a.zoom(a._googleMap.zoom),a._prevZoom=a.zoom()}),this._googleStreetViewService=new google.maps.StreetViewService,this._googleMapPanorama=this._googleMap.getStreetView(),this._googleMapPanorama.addListener("visible_changed",function(){a.streetView(a._googleMapPanorama.getVisible()),a._prevStreetView=a.streetView()}),this._circleMap=e.map([]),this._pinMap=e.map([]),this._prevCenterLat=this.centerLat(),this._prevCenterLong=this.centerLong(),this._prevZoom=this.zoom();var n={strokeWeight:0,fillOpacity:.45,fillColor:"#1f77b4",editable:!0,clickable:!0};this._drawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["polygon","rectangle","circle"]},rectangleOptions:n,circleOptions:n,polygonOptions:n}),this.drawingState()&&this._userShapes.load(this.drawingState())},a.prototype.update=function(e,t){var o=this;this._googleMap.setMapTypeId(this.getMapType()),this._googleMap.setOptions(this.getMapOptions()),this.centerAddress_exists()&&this._prevCenterAddress!==this.centerAddress()&&(this._prevCenterAddress=this.centerAddress(),this._googleGeocoder.geocode({address:this.centerAddress()},function(e,t){t===google.maps.GeocoderStatus.OK?o._googleMap.fitBounds(e[0].geometry.bounds):console.error("Geocode was not successful for the following reason: "+t)})),(this._prevCenterLat!==this.centerLat()||this._prevCenterLong!==this.centerLong())&&(this._googleMap.setCenter(new google.maps.LatLng(this.centerLat(),this.centerLong())),this._prevCenterLat=this.centerLat(),this._prevCenterLong=this.centerLong()),this._prevZoom!==this.zoom()&&(this._googleMap.setZoom(this.zoom()),this._prevZoom=this.zoom()),this.updateCircles(),this.updatePins(),this._prevStreetView!==this.streetView()&&(this.streetView()?(this._googleMapPanorama.setPosition({lat:this.centerLat(),lng:this.centerLong()}),this._googleMapPanorama.setPov({heading:0,pitch:0}),this._googleMapPanorama.setVisible(!0)):this._googleMapPanorama.setVisible(!1),this._prevStreetView=this.streetView()),this.drawingTools()?(this._drawingManager.setMap(this._googleMap),google.maps.event.addListener(this._drawingManager,"overlaycomplete",function(){a.prototype.onDrawingComplete.apply(o,arguments)})):(this._drawingManager.setMap(null),google.maps.event.clearInstanceListeners(this._drawingManager))},a.prototype.requireGoogleMap=function(){return this._googleMapPromise||(this._googleMapPromise=new Promise(function(e,t){window.google&&window.google.maps&&e();var o="https:"===window.location.protocol?"https:":"http:",i=__hpcc_gmap_apikey||"AIzaSyDwGn2i1i_pMZvnqYJN1BksD_tjYaCOWKg";require(["async!"+o+"//maps.google.com/maps/api/js?key="+i+"&libraries=drawing,geometry"],function(){e()})})),this._googleMapPromise},a.prototype.render=function(e){var o=this,i=arguments;return this.requireGoogleMap().then(function(){t.prototype.render.apply(o,i)}),this},a.prototype.streetViewAt=function(e,t){t=t||1e3;var o=this;this._googleStreetViewService.getPanorama({location:e,radius:t},function(t,i){if("OK"===i){var r=new google.maps.Marker({position:e,map:o._googleMap}),a=google.maps.geometry.spherical.computeHeading(t.location.latLng,new google.maps.LatLng(e.lat,e.lng));o._googleMapPanorama.setPano(t.location.pano),o._googleMapPanorama.setPov({heading:a,pitch:0}),o._googleMapPanorama.setVisible(!0);var n=google.maps.event.addListener(o._googleMap.getStreetView(),"visible_changed",function(){this.getVisible()||(r.setMap(null),google.maps.event.removeListener(n))})}else console.error("Street View data not found for this location.")})},a.prototype.updateCircles=function(){function t(e){return e[0]+"_"+e[1]}var o=[],i=[],r=e.map(this._circleMap.keys(),function(e){return e});this.data().forEach(function(e){r.remove(t(e)),e[3]&&!this._circleMap.has(t(e))?o.push(e):e[3]&&this._circleMap.has(t(e))?i.push(e):!e[3]&&this._circleMap.has(t(e))&&r.set(t(e),!0)},this),o.forEach(function(e){var o=this.createCircle(e[0],e[1],e[3],"");this._circleMap.set(t(e),o)},this),i.forEach(function(e){},this);var a=this;r.forEach(function(e){a._circleMap.get(e).setMap(null),a._circleMap.remove(e)})},a.prototype.updatePins=function(){function t(e){return e[0]+"_"+e[1]}var o=[],i=[],r=e.map(this._pinMap.keys(),function(e){return e});this.data().forEach(function(e){r.remove(t(e)),e[2]&&!this._pinMap.has(t(e))?o.push(e):e[2]&&this._pinMap.has(t(e))?i.push(e):!e[2]&&this._pinMap.has(t(e))&&r.set(t(e),!0)},this),o.forEach(function(e){var o=this.createMarker(e[0],e[1],e[2],"");this._pinMap.set(t(e),o)},this),i.forEach(function(e){this._pinMap.get(t(e)).setIcon(this.createIcon(e[2]))},this);var a=this;r.forEach(function(e){a._pinMap.get(e).setMap(null),a._pinMap.remove(e)})},a.prototype.createIcon=function(e){return{path:"M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30",fillColor:e.fillColor,fillOpacity:e.fillOpacity||.8,scale:.5,strokeColor:e.strokeColor||"black",strokeWeight:.25}},a.prototype.createMarker=function(e,t,o){return new google.maps.Marker({position:new google.maps.LatLng(e,t),animation:google.maps.Animation.DROP,title:o.title||"",icon:this.createIcon(o),map:this._googleMap})},a.prototype.createCircle=function(e,t,o){return new google.maps.Circle({center:new google.maps.LatLng(e,t),radius:16093*o.radius/10,fillColor:o.fillColor||"red",strokeColor:o.strokeColor||o.fillColor||"black",strokeWeight:.5,map:this._googleMap})},a.prototype.zoomTo=function(e,t){t=t||this.singleZoomToMaxZoom();var o=0,i=new google.maps.LatLngBounds;switch(e.forEach(function(e){var t=new google.maps.LatLng(e[0],e[1]);i.extend(t),++o}),o){case 0:break;case 1:this._googleMap.setCenter(i.getCenter()),this._googleMap.setZoom(t);break;default:this._googleMap.fitBounds(i)}return this},a.prototype.zoomToFit=function(){return this.zoomTo(this.data())},a.prototype.drawingOptions=function(e){return arguments.length?(this._drawingManager.setOptions(e),this):this._drawingManager},a.prototype.userShapeSelection=function(e){return arguments.length?(this._userShapeSelection&&this._userShapeSelection.setEditable(!1),this._userShapeSelection=e,this._userShapeSelection&&this._userShapeSelection.setEditable(!0),this):this._userShapeSelection},a.prototype.deleteUserShape=function(e){this._userShapeSelection===e&&this.userShapeSelection(null),this._userShapes.remove(e)},a.prototype.onDrawingComplete=function(e){if(e.type!==google.maps.drawing.OverlayType.MARKER){this._drawingManager.setDrawingMode(null);var t=e.overlay;t.__hpcc_type=e.type,this._userShapes.add(t);var o=this,i=!1;window.addEventListener("keydown",function(e){("Control"===e.keyIdentifier||e.ctrlKey===!0)&&(i=!0)}),window.addEventListener("keyup",function(e){e.ctrlKey===!1&&(i=!1)}),google.maps.event.addListener(t,"click",function(e){return o.userShapeSelection(t),e&&i===!0&&(o.deleteUserShape(t),o.drawingState(JSON.stringify(o._userShapes.save()))),!1}),this.userShapeSelection(t),this.drawingState(JSON.stringify(this._userShapes.save()))}},a});