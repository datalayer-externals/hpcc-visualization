!function(e,t){"function"==typeof define&&define.amd?define(["d3","../common/HTMLWidget","../layout/AbsoluteSurface","css!./GMap"],t):e.map_GMap=t(e.d3,e.common_HTMLWidget,e.layout_AbsoluteSurface)}(this,function(e,t,o){function r(e,t,o){function r(e,t,o){google.maps.OverlayView.call(this),this._div=null,this._worldSurface=t,this._viewportSurface=o,this._map=e,this.setMap(e);var r=this;google.maps.event.addListener(e,"bounds_changed",function(){r.draw()}),google.maps.event.addListener(e,"projection_changed",function(){r.draw()}),this._prevWorldMin={x:0,y:0},this._prevWorldMax={x:0,y:0},this._prevMin={x:0,y:0},this._prevMax={x:0,y:0}}return r.prototype=google.maps.OverlayView.prototype,r.prototype.onAdd=function(){this.div=document.createElement("div"),this._viewportSurface.target(this.div).units("pixels");var e=this.getPanes();e.overlayMouseTarget.appendChild(this.div)},r.prototype.draw=function(){var e=this.getProjection();if(e){for(var t=this._map.getBounds(),o=e.fromLatLngToDivPixel(t.getCenter()),r=e.fromLatLngToDivPixel(t.getSouthWest()),i=e.fromLatLngToDivPixel(t.getNorthEast()),s={x:r.x,y:i.y},n={x:i.x,y:r.y},a=e.getWorldWidth();n.x<s.x+100;)n.x+=a;for(;s.x>o.x;)s.x-=a,n.x-=a;(s.x!==this._prevMin.x||s.y!==this._prevMin.y||n.x!==this._prevMax.x||n.y!==this._prevMax.y)&&(this._viewportSurface.widgetX(s.x).widgetY(s.y).widgetWidth(n.x-s.x).widgetHeight(n.y-s.y),this._viewportSurface._renderCount?(this._viewportSurface.render(),this._prevMin=s,this._prevMax=n):this._viewportSurface.lazyRender());for(var p=e.fromLatLngToDivPixel(new google.maps.LatLng(85,-179.9)),l=e.fromLatLngToDivPixel(new google.maps.LatLng(-85,179.9));l.x<p.x+100;)l.x+=a;for(;p.x>o.x;)p.x-=a,l.x-=a;(p.x!==this._prevWorldMin.x||p.y!==this._prevWorldMin.y||l.x!==this._prevWorldMax.x||l.y!==this._prevWorldMax.y)&&(this._worldSurface.widgetX(p.x).widgetY(p.y).widgetWidth(l.x-p.x).widgetHeight(l.y-p.y).render(),this._prevWorldMin=l,this._prevWorldMax=l)}},r.prototype.onRemove=function(){this._viewportSurface.target(null),this._div.parentNode.removeChild(this._div),this._div=null},new r(e,t,o)}function i(){function e(e,t,o){var i=r._overlay.getProjection(),s=i.fromLatLngToDivPixel(new google.maps.LatLng(t,o)),n=i.getWorldWidth(),a=parseFloat(e.widgetX()),p=parseFloat(e.widgetY()),l=parseFloat(e.widgetWidth());for(s.x-=a,s.y-=p;s.x<0;)s.x+=n;for(;s.x>l;)s.x-=n;return s}t.call(this),this._tag="div";var r=this;this._worldSurface=new o,this._worldSurface.project=function(t,o){return e(this,t,o)},this._viewportSurface=new o,this._viewportSurface.project=function(t,o){return e(this,t,o)}}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype._class+=" map_GMap",i.prototype.publish("type","road","set","Map Type",["terrain","road","satellite","hybrid"],{tags:["Basic"]}),i.prototype.publish("centerLat",42.877742,"number","Center Latitude",null,{tags:["Basic"]}),i.prototype.publish("centerLong",-97.380979,"number","Center Longtitude",null,{tags:["Basic"]}),i.prototype.publish("centerAddress",null,"string","Address to center map on",null,{tags:["Basic"],optional:!0}),i.prototype.publish("zoom",4,"number","Zoom Level",null,{tags:["Basic"]}),i.prototype.publish("panControl",!0,"boolean","Pan Controls",null,{tags:["Basic"]}),i.prototype.publish("zoomControl",!0,"boolean","Zoom Controls",null,{tags:["Basic"]}),i.prototype.publish("scaleControl",!0,"boolean","Scale Controls",null,{tags:["Basic"]}),i.prototype.publish("mapTypeControl",!1,"boolean","Map Type Controls",null,{tags:["Basic"]}),i.prototype.publish("fullscreenControl",!1,"boolean","Fullscreen Controls",null,{tags:["Basic"]}),i.prototype.publish("streetViewControl",!1,"boolean","StreetView Controls",null,{tags:["Basic"]}),i.prototype.publish("overviewMapControl",!1,"boolean","OverviewMap Controls",null,{tags:["Basic"]}),i.prototype.publish("streetView",!1,"boolean","Streetview",null,{tags:["Basic"]}),i.prototype.publish("googleMapStyles",{},"object","Styling for map colors etc",null,{tags:["Basic"]}),i.prototype.data=function(e){var o=t.prototype.data.apply(this,arguments);return o},i.prototype.getMapType=function(){switch(this.type()){case"terrain":return google.maps.MapTypeId.TERRAIN;case"road":return google.maps.MapTypeId.ROADMAP;case"satellite":return google.maps.MapTypeId.SATELLITE;case"hybrid":return google.maps.MapTypeId.HYBRID;default:return google.maps.MapTypeId.ROADMAP}},i.prototype.getMapOptions=function(){return{panControl:this.panControl(),zoomControl:this.zoomControl(),fullscreenControl:this.fullscreenControl(),mapTypeControl:this.mapTypeControl(),scaleControl:this.scaleControl(),streetViewControl:this.streetViewControl(),overviewMapControl:this.overviewMapControl(),overviewMapControlOptions:{opened:!0},styles:this.googleMapStyles()}},i.prototype.size=function(e){var o=t.prototype.size.apply(this,arguments);return arguments.length&&this._googleMapNode&&(this._googleMapNode.style({width:e.width+"px",height:e.height+"px"}),google.maps.event.trigger(this._googleMap,"resize")),o},i.prototype.enter=function(o,i){t.prototype.enter.apply(this,arguments);var s=this;this._googleGeocoder=new google.maps.Geocoder,this._googleMapNode=i.append("div").style({width:this.width()+"px",height:this.height()+"px"}),this._googleMap=new google.maps.Map(this._googleMapNode.node(),{zoom:this.zoom(),center:new google.maps.LatLng(this.centerLat(),this.centerLong()),mapTypeId:this.getMapType(),disableDefaultUI:!0}),this._overlay=r(this._googleMap,this._worldSurface,this._viewportSurface),this._googleMap.addListener("center_changed",function(){s.centerLat(s._googleMap.center.lat()),s._prevCenterLat=s.centerLat(),s.centerLong(s._googleMap.center.lng()),s._prevCenterLong=s.centerLong(),s._googleMapPanorama.setPosition({lat:s.centerLat(),lng:s.centerLong()}),s.zoom(s._googleMap.getZoom()),s._prevZoom=s.zoom()}),this._googleMap.addListener("zoom_changed",function(){s.zoom(s._googleMap.zoom),s._prevZoom=s.zoom()}),this._googleMapPanorama=this._googleMap.getStreetView(),this._googleMapPanorama.addListener("visible_changed",function(){s.streetView(s._googleMapPanorama.getVisible()),s._prevStreetView=s.streetView()}),this._circleMap=e.map([]),this._pinMap=e.map([]),this._prevCenterLat=this.centerLat(),this._prevCenterLong=this.centerLong(),this._prevZoom=this.zoom()},i.prototype.update=function(e,t){var o=this;this._googleMap.setMapTypeId(this.getMapType()),this._googleMap.setOptions(this.getMapOptions()),this.centerAddress_exists()&&this._prevCenterAddress!==this.centerAddress()&&(this._prevCenterAddress=this.centerAddress(),this._googleGeocoder.geocode({address:this.centerAddress()},function(e,t){t===google.maps.GeocoderStatus.OK?o._googleMap.fitBounds(e[0].geometry.bounds):console.error("Geocode was not successful for the following reason: "+t)})),(this._prevCenterLat!==this.centerLat()||this._prevCenterLong!==this.centerLong())&&(this._googleMap.setCenter(new google.maps.LatLng(this.centerLat(),this.centerLong())),this._prevCenterLat=this.centerLat(),this._prevCenterLong=this.centerLong()),this._prevZoom!==this.zoom()&&(this._googleMap.setZoom(this.zoom()),this._prevZoom=this.zoom()),this.updateCircles(),this.updatePins(),this._prevStreetView!==this.streetView()&&(this.streetView()?(this._googleMapPanorama.setPosition({lat:this.centerLat(),lng:this.centerLong()}),this._googleMapPanorama.setPov({heading:0,pitch:0}),this._googleMapPanorama.setVisible(!0)):this._googleMapPanorama.setVisible(!1),this._prevStreetView=this.streetView())},i.prototype.requireGoogleMap=function(){return this._googleMapPromise||(this._googleMapPromise=new Promise(function(e,t){window.google&&window.google.maps&&e();var o="https:"===window.location.protocol?"https:":"http:",r=r||"AIzaSyDwGn2i1i_pMZvnqYJN1BksD_tjYaCOWKg";require(["async!"+o+"//maps.google.com/maps/api/js?key="+r+"&libraries=drawing,geometry"],function(){e()})})),this._googleMapPromise},i.prototype.render=function(e){var o=this,r=arguments;return this.requireGoogleMap().then(function(){t.prototype.render.apply(o,r)}),this},i.prototype.updateCircles=function(){function t(e){return e[0]+"_"+e[1]}var o=[],r=[],i=e.map(this._circleMap.keys(),function(e){return e});this.data().forEach(function(e){i.remove(t(e)),e[3]&&!this._circleMap.has(t(e))?o.push(e):e[3]&&this._circleMap.has(t(e))?r.push(e):!e[3]&&this._circleMap.has(t(e))&&i.set(t(e),!0)},this),o.forEach(function(e){var o=this.createCircle(e[0],e[1],e[3],"");this._circleMap.set(t(e),o)},this),r.forEach(function(e){},this);var s=this;i.forEach(function(e){s._circleMap.get(e).setMap(null),s._circleMap.remove(e)})},i.prototype.updatePins=function(){function t(e){return e[0]+"_"+e[1]}var o=[],r=[],i=e.map(this._pinMap.keys(),function(e){return e});this.data().forEach(function(e){i.remove(t(e)),e[2]&&!this._pinMap.has(t(e))?o.push(e):e[2]&&this._pinMap.has(t(e))?r.push(e):!e[2]&&this._pinMap.has(t(e))&&i.set(t(e),!0)},this),o.forEach(function(e){var o=this.createMarker(e[0],e[1],e[2],"");this._pinMap.set(t(e),o)},this),r.forEach(function(e){this._pinMap.get(t(e)).setIcon(this.createIcon(e[2]))},this);var s=this;i.forEach(function(e){s._pinMap.get(e).setMap(null),s._pinMap.remove(e)})},i.prototype.createIcon=function(e){return{path:"M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30",fillColor:e.fillColor,fillOpacity:e.fillOpacity||.8,scale:.5,strokeColor:e.strokeColor||"black",strokeWeight:.25}},i.prototype.createMarker=function(e,t,o){return new google.maps.Marker({position:new google.maps.LatLng(e,t),animation:google.maps.Animation.DROP,title:o.title||"",icon:this.createIcon(o),map:this._googleMap})},i.prototype.createCircle=function(e,t,o){return new google.maps.Circle({center:new google.maps.LatLng(e,t),radius:16093*o.radius/10,fillColor:o.fillColor||"red",strokeColor:o.strokeColor||o.fillColor||"black",strokeWeight:.5,map:this._googleMap})},i.prototype.zoomTo=function(e){var t=0,o=new google.maps.LatLngBounds;return e.forEach(function(e){var r=new google.maps.LatLng(e[0],e[1]);o.extend(r),++t}),t&&(this._googleMap.setCenter(o.getCenter()),this._googleMap.fitBounds(o),this._googleMap.getZoom()>12&&this._googleMap.setZoom(12)),this},i.prototype.zoomToFit=function(){return this.zoomTo(this.data())},i});