"function"==typeof define&&define.amd&&define("css",[],function(){return{load:function(t,e,o){o()}}}),function(t,e){"function"==typeof define&&define.amd?define("graph/Edge",["d3","../common/SVGWidget","../common/TextBox","css!./Edge"],e):t.graph_Edge=e(t.d3,t.common_SVGWidget,t.common_TextBox)}(this,function(t,e,o){function i(){e.call(this),this._points=[],this._weight=100,this._strokeDasharray=null,this._hidden=!1,this._textBox=(new o).padding(0)}return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype._class+=" graph_Edge",i.prototype.publish("arcDepth",16,"number","Arc Depth",null,{tags:["Basic"]}),i.prototype.publish("showArc",!0,"boolean","Show/Hide Arc",null,{tags:["Basic"]}),i.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),i.prototype.publish("sourceMarker","circle","set","Source Marker",["circle"],{optional:!0}),i.prototype.publish("targetMarker","arrow","set","Source Marker",["arrow","circle"],{optional:!0}),i.prototype.publish("strokeDasharray",null,"string","Stroke Dash Array",null,{optional:!0}),i.prototype.publish("strokeColor",null,"html-color","Stroke Color",null,{optional:!0}),i.prototype.sourceVertex=function(t){return arguments.length?(this._sourceVertex=t,this):this._sourceVertex},i.prototype.targetVertex=function(t){return arguments.length?(this._targetVertex=t,this):this._targetVertex},i.prototype.weight=function(t){return arguments.length?(this._weight=t,this):this._weight},i.prototype.points=function(t,e,o){return arguments.length?(this._points=t,this._elementPath&&this.update(null,this._element,e,o),this):this._points},i.prototype.hidden=function(t){return arguments.length?(this._hidden=t,this):this._hidden},i.prototype.text=function(t){return arguments.length?(this._textBox.text(t),this):this._textBox.text()},i.prototype.enter=function(t,o){e.prototype.enter.apply(this,arguments),this._elementPath=o.append("path"),this._tooltipElement=this._elementPath.append("title"),this._textBox.text()&&this._textBox.target(t).tooltip(this.tooltip()).render()},i.prototype.update=function(o,i,r,n){e.prototype.update.apply(this,arguments);var a=this;this.svgMarkerGlitch&&!n&&i.transition().duration((r?r:0)+100).each("start",function(t){a._pushMarkers(i,t)}).each("end",function(t){a._popMarkers(i,t)});var s=a._calculateEdgePoints(this._sourceVertex,this._targetVertex,this._points),h="";if(this._points.length||r,0){var l=s[2].x-s[0].x,c=s[2].y-s[0].y,p=2*Math.sqrt(l*l+c*c);h="M"+s[0].x+","+s[0].y+"A"+p+","+p+" 0 0,1 "+s[2].x+","+s[2].y}else h=t.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("bundle").tension(.75)(s);var u=this._elementPath;r&&(u=u.transition().duration(r)),u.attr("opacity",this._hidden?0:1).attr("marker-start",this.svgMarkerGlitch&&n||!this.sourceMarker_exists()?null:"url(#"+this._graphID+"_"+this.sourceMarker()+"Foot)").attr("marker-end",this.svgMarkerGlitch&&n||!this.targetMarker_exists()?null:"url(#"+this._graphID+"_"+this.targetMarker()+"Head)").attr("stroke",this.strokeColor_exists()?this.strokeColor():null).attr("stroke-dasharray",this.strokeDasharray_exists()?this.strokeDasharray():null).attr("d",h),this._tooltipElement.text(this.tooltip()),this._textBox.text()&&this._textBox.tooltip(this.tooltip()).move(this._findMidPoint(s),r)},i.prototype._findMidPoint=function(t){var e=t.length/2;if(t.length%2)return t[Math.floor(e)];if(t.length){var o=t[e-1],i=t[e];return{x:(o.x+i.x)/2,y:(o.y+i.y)/2}}return{x:0,y:0}},i.prototype._calculateEdgePoints=function(t,e,o){if(!t||!e)return[{x:0,y:0},{x:0,y:0}];var i=o?o.slice():[],r=0===i.length?e.pos():i[0],n=0===i.length?t.pos():i[i.length-1];if(i.unshift(t.intersection(t._pos,r)),i.push(e.intersection(e._pos,n)),i[0]||(i[0]=t._pos),i[i.length-1]||(i[i.length-1]=e._pos),2===i.length&&i[0]&&i[1]){var a=i[0].x-i[1].x,s=i[0].y-i[1].y,h=Math.sqrt(a*a+s*s);if(h)if(this.showArc()){var l=(i[0].x+i[1].x)/2-s*this.arcDepth()/100,c=(i[0].y+i[1].y)/2+a*this.arcDepth()/100;i=[{x:i[0].x,y:i[0].y},{x:l,y:c},{x:i[1].x,y:i[1].y}]}else i=[{x:i[0].x,y:i[0].y},{x:i[1].x,y:i[1].y}]}return i},i}),function(t,e){"function"==typeof define&&define.amd?define("graph/EdgeC",["d3","../common/CanvasWidget"],e):t.graph_EdgeC=e(t.d3,t.common_CanvasWidget)}(this,function(t,e){function o(){e.call(this),this._text="",this._points=[],this._weight=100,this._strokeDasharray=null,this._hidden=!1}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype._class+=" graph_EdgeC",o.prototype.publish("arcDepth",16,"number","Arc Depth",null,{tags:["Basic"]}),o.prototype.publish("showArc",!0,"boolean","Show/Hide Arc",null,{tags:["Basic"]}),o.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),o.prototype.publish("sourceMarker","circle","set","Source Marker",["circle"],{optional:!0}),o.prototype.publish("targetMarker","arrow","set","Source Marker",["arrow","circle"],{optional:!0}),o.prototype.publish("strokeDasharray",null,"string","Stroke Dash Array",null,{optional:!0}),o.prototype.publish("strokeColor","#777","html-color","Stroke Color",null,{optional:!0}),o.prototype.sourceVertex=function(t){return arguments.length?(this._sourceVertex=t,this):this._sourceVertex},o.prototype.targetVertex=function(t){return arguments.length?(this._targetVertex=t,this):this._targetVertex},o.prototype.weight=function(t){return arguments.length?(this._weight=t,this):this._weight},o.prototype.points=function(t,e,o){return arguments.length?(this._points=t,this):this._points},o.prototype.hidden=function(t){return arguments.length?(this._hidden=t,this):this._hidden},o.prototype.text=function(t){return arguments.length?(this._text=t,this):this._text},o.prototype.drawSelf=function(t,e){var o=this;if(t.beginPath(),t.strokeStyle=this.strokeColor(),t.moveTo(o._sourceVertex.x(),o._sourceVertex.y()),t.lineTo(o._targetVertex.x(),o._targetVertex.y()),t.stroke(),t.closePath(),this.text()){var i=(o._sourceVertex.x()+o._targetVertex.x())/2,r=(o._sourceVertex.y()+o._targetVertex.y())/2;t.fillStyle="#ffffff";var n=12;t.textBaseline="top",t.font=n+"px Arial";var a=n/4,s=t.measureText(this.text()).width;t.fillRect(i-s/2,r-n/2,s+2*a,n+2*a),t.fillStyle="#000000",t.fillText(this.text(),i-s/2+a,r-n/2)}},o}),function(t,e){"function"==typeof define&&define.amd?define("graph/Vertex.js",["d3","../common/SVGWidget","../common/Icon","../common/TextBox","css!./Vertex"],e):t.graph_Vertex=e(t.d3,t.common_SVGWidget,t.common_Icon,t.common_TextBox)}(this,function(t,e,o,i){function r(){e.call(this),this._icon=new o,this._textBox=new i,this._annotationWidgets={}}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype._class+=" graph_Vertex",r.prototype.publishProxy("faChar","_icon"),r.prototype.publishProxy("imageUrl","_icon"),r.prototype.publishProxy("icon_shape_diameter","_icon","diameter"),r.prototype.publishProxy("icon_shape_colorFill","_icon","shape_colorFill"),r.prototype.publishProxy("icon_shape_colorStroke","_icon","shape_colorStroke"),r.prototype.publishProxy("icon_image_colorFill","_icon","image_colorFill"),r.prototype.publish("centroid",!1,"boolean","Centroid Vertex"),r.prototype.publishProxy("text","_textBox"),r.prototype.publishProxy("anchor","_textBox"),r.prototype.publishProxy("textbox_shape_colorStroke","_textBox","shape_colorStroke"),r.prototype.publishProxy("textbox_shape_colorFill","_textBox","shape_colorFill"),r.prototype.publishProxy("textbox_text_colorFill","_textBox","text_colorFill"),r.prototype.publish("iconAnchor","start","set","Icon Anchor Position",["","start","middle","end"],{tags:["Basic"]}),r.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),r.prototype.publish("iconTooltip","","string","iconTooltip",null,{tags:["Private"]}),r.prototype.publish("annotationDiameter",14,"number","Annotation Diameter",null,{tags:["Private"]}),r.prototype.publish("annotationSpacing",3,"number","Annotation Spacing",null,{tags:["Private"]}),r.prototype.publish("annotationIcons",[],"array","Annotations",null,{tags:["Private"]}),r.prototype.enter=function(t,o){e.prototype.enter.apply(this,arguments),this._icon.target(t).render(),this._textBox.target(t).render()},r.prototype.update=function(i,r){e.prototype.update.apply(this,arguments),r.classed("centroid",this.centroid()),r.style("filter",this.centroid()?"url(#"+this._graphID+"_glow)":null),this._icon.tooltip(this.iconTooltip()?this.iconTooltip():this.tooltip()).render();var n=this._icon.getBBox(!0);this._textBox.tooltip(this.tooltip()).render();var a=this._textBox.getBBox(!0);switch(this.iconAnchor()){case"start":this._icon.move({x:-(a.width/2)+n.width/3,y:-(a.height/2)-n.height/3});break;case"middle":this._icon.move({x:0,y:-(a.height/2)-n.height/3});break;case"end":this._icon.move({x:a.width/2-n.width/3,y:-(a.height/2)-n.height/3})}var s=this,h=r.selectAll(".annotation").data(this.annotationIcons());h.enter().append("g").attr("class","annotation").each(function(t,e){s._annotationWidgets[e]=(new o).target(this).shape("square")});var l=a.width/2,c=a.height/2;h.each(function(t,e){var o=s._annotationWidgets[e];o.diameter(s.annotationDiameter()).shape_colorFill(s.textbox_shape_colorFill()).shape_colorStroke(s.textbox_shape_colorStroke());for(var i in t)o[i]?o[i](t[i]):window.__hpcc_debug&&console.log("Invalid annotation property:  "+i);o.render();var r=o.getBBox(!0);o.move({x:l-r.width/2+4,y:c+r.height/2-4}),l-=r.width+s.annotationSpacing()}),h.exit().each(function(e,o){var i=t.select(this);delete s._annotationWidgets[o],i.remove()})},r.prototype.intersection=function(t,e){var o=this._icon.intersection(t,e,this._pos);if(o)return o;var i=this._textBox.intersection(t,e,this._pos);return i?i:null},r}),function(t,e){"function"==typeof define&&define.amd?define("graph/GraphData.js",["dagre"],e):t.graph_GraphData=e(t.dagre)}(this,function(t){function e(){t.graphlib.Graph.call(this,{multigraph:!0,compound:!0}),this.setGraph({}),this.setDefaultNodeLabel(function(){return{}}),this.setDefaultEdgeLabel(function(){return{}})}return e.prototype=Object.create(t.graphlib.Graph.prototype),e.prototype.constructor=e,e.prototype.setData=function(t,e,o,i){for(var r=this,n={addedVertices:[],addedEdges:[]},a=0;a<t.length;++a){var s=t[a];i&&this.hasNode(s._id)||(this.setNode(s._id,s),n.addedVertices.push(s))}for(a=0;a<e.length;++a){var h=e[a];i&&this.hasEdge(h._id)||(h._sourceVertex&&h._targetVertex?(this.setEdge(h._sourceVertex._id,h._targetVertex._id,h,h._id),n.addedEdges.push(h)):console.log("Bad edge definition"))}if(o)for(a=0;a<o.length;++a)this.setParent(o[a].child._id,o[a].parent._id);if(i){var l=e.map(function(t){return t._id});this.filterEdges(function(t){return l.indexOf(t.v+"_"+t.w)<0}).forEach(function(t){});var c=t.map(function(t){return t._id});this.filterNodes(function(t){return c.indexOf(t)<0}).forEach(function(t){try{r.delNode(t)}catch(e){}})}return n},e.prototype.filterEdges=function(t){var e=[];return this.eachEdge(function(o){t(o)&&e.push(o)}),e},e.prototype.filterNodes=function(t){var e=[];return this.eachNode(function(o){t(o)&&e.push(o)}),e},e.prototype.nodeValues=function(){var t=[];return this.nodes().forEach(function(e,o){t.push(this.node(e))},this),t},e.prototype.eachNode=function(t){this.nodes().forEach(function(e,o){t(e,this.node(e))},this)},e.prototype.edgeValues=function(){var t=[];return this.edges().forEach(function(e,o){t.push(this.edge(e))},this),t},e.prototype.eachEdge=function(t){this.edges().forEach(function(e,o){t(e,e.v,e.w,this.edge(e))},this)},e.prototype.getJSON=function(){var e=t.graphlib.json.write(this);return JSON.stringify(e,function(t,e){return"value"===t?e._text&&e._text._text?e._text._text:e._id:e},"  ")},e}),function(t,e){"function"==typeof define&&define.amd?define("graph/GraphLayouts.js",["d3","dagre"],e):t.graph_GraphLayouts=e(t.d3,t.dagre)}(this,function(t,e){function o(t,e,o,i){var r=this;this.pos={};var n=0;i=i||(o>e?e-n:o-n)/2;var a=t.nodeCount(),s=-Math.PI/2,h=2*Math.PI/a;t.eachNode(function(t,e){var o=e.getBBox(!0),n=Math.max(o.width,o.height);r.pos[t]={x:e.fixed?e.x:Math.cos(s)*(i-n),y:e.fixed?e.y:Math.sin(s)*(i-n),width:o.width,height:o.height},s+=h})}function i(t,e,o,i){var r=this;this.pos={},t.eachNode(function(t,e){r.pos[t]={x:e.x,y:e.y,width:e.width,height:e.height}})}function r(e,o,i,r){r=r||{};var n=this;if(this.pos={},this.vertices=[],this.vertexMap={},e.eachNode(function(t){var o=e.node(t),i=o.getBBox(!0),r={id:t,x:o.pos().x,y:o.pos().y,width:i.width,height:i.height,value:o};n.vertices.push(r),n.vertexMap[t]=r}),this.edges=[],e.eachEdge(function(t,e,o){n.edges.push({source:n.vertexMap[e],target:n.vertexMap[o]})}),this.force=t.layout.force().linkDistance(r.linkDistance).linkStrength(r.linkStrength).friction(r.friction).charge(function(t){var e=t.value.getBBox();return r.charge*Math.max(e.width,e.height)}).chargeDistance(r.chargeDistance).theta(r.theta).gravity(r.gravity).nodes(this.vertices).links(this.edges),r.oneShot){this.force.start();var a=e.nodeCount();a=Math.min(a*a,500);for(var s=0;a>s;++s)this.force.tick();this.force.stop()}}function n(t,o,i,r){var n=new e.graphlib.Graph({multigraph:!0,compound:!0}).setGraph(r).setDefaultNodeLabel(function(){return{}}).setDefaultEdgeLabel(function(){return{}});t.eachNode(function(e){var o=t.node(e),i=o.getBBox();n.setNode(e,{width:i.width,height:i.height})}),t.eachEdge(function(e,o,i){var r=t.edge(e);n.setEdge(o,i,{weight:r.weight()},r._id)}),t.eachNode(function(e){n.setParent(e,t.parent(e))}),this.dagreLayout=e.layout(n);var a=-n.graph().width/2,s=-n.graph().height/2;n.nodes().forEach(function(t){var e=n.node(t);e.x+=a,e.y+=s}),n.edges().forEach(function(t){for(var e=n.edge(t),o=0;o<e.points.length;++o)e.points[o].x+=a,e.points[o].y+=s}),this.digraph=n}o.prototype.nodePos=function(t){return this.pos[t]},o.prototype.edgePoints=function(t){return[]},i.prototype.nodePos=function(t){return this.pos[t]},i.prototype.edgePoints=function(t){return[]},r.prototype.nodePos=function(t){return this.vertexMap[t]},r.prototype.edgePoints=function(t){return[]},n.prototype.nodePos=function(t){return this.digraph.node(t)},n.prototype.edgePoints=function(t){return this.digraph.edge(t._sourceVertex.id(),t._targetVertex.id(),t._id).points};var a={None:i,Circle:o,ForceDirected:r,Hierarchy:n};return a}),function(t,e){"function"==typeof define&&define.amd?define("graph/Graph.js",["d3","../common/SVGWidget","../common/Palette","../api/IGraph","./Vertex","./Edge","./GraphData","./GraphLayouts","../common/Utility","css!./Graph"],e):t.graph_Graph=e(t.d3,t.common_SVGWidget,t.common_Palette,t.api_IGraph,t.graph_Vertex,t.graph_Edge,t.graph_GraphData,t.graph_GraphLayouts,t.common_Utility)}(this,function(t,e,o,i,r,n,a,s,h){function l(){e.call(this),i.call(this),this.graphData=new a,this.highlight={zoom:1.1,opacity:.33,edge:"1.25px"},this._selection=new h.Selection}return l.prototype=Object.create(e.prototype),l.prototype.constructor=l,l.prototype._class+=" graph_Graph",l.prototype["implements"](i.prototype),l.prototype.Vertex=r,l.prototype.Edge=n,l.prototype.publish("allowDragging",!0,"boolean","Allow Dragging of Vertices",null,{tags:["Advanced"]}),l.prototype.publish("layout","Circle","set","Default Layout",["Circle","ForceDirected","ForceDirected2","Hierarchy","None"],{tags:["Basic"]}),l.prototype.publish("scale","100%","set","Zoom Level",["all","width","selection","100%","90%","75%","50%","25%","10%"],{tags:["Basic"]}),l.prototype.publish("applyScaleOnLayout",!1,"boolean","Shrink to fit on Layout",null,{tags:["Basic"]}),l.prototype.publish("highlightOnMouseOverVertex",!1,"boolean","Highlight Vertex on Mouse Over",null,{tags:["Basic"]}),l.prototype.publish("highlightOnMouseOverEdge",!1,"boolean","Highlight Edge on Mouse Over",null,{tags:["Basic"]}),l.prototype.publish("transitionDuration",250,"number","Transition Duration",null,{tags:["Intermediate"]}),l.prototype.publish("showEdges",!0,"boolean","Show Edges",null,{tags:["Intermediate"]}),l.prototype.publish("snapToGrid",0,"number","Snap to Grid",null,{tags:["Private"]}),l.prototype.publish("hierarchyRankDirection","TB","set","Direction for Rank Nodes",["TB","BT","LR","RL"],{tags:["Advanced"]}),l.prototype.publish("hierarchyNodeSeparation",50,"number","Number of pixels that separate nodes horizontally in the layout",null,{tags:["Advanced"]}),l.prototype.publish("hierarchyEdgeSeparation",10,"number","Number of pixels that separate edges horizontally in the layout",null,{tags:["Advanced"]}),l.prototype.publish("hierarchyRankSeparation",50,"number","Number of pixels between each rank in the layout",null,{tags:["Advanced"]}),l.prototype.publish("forceDirectedLinkDistance",300,"number","Target distance between linked nodes",null,{tags:["Advanced"]}),l.prototype.publish("forceDirectedLinkStrength",1,"number","Strength (rigidity) of links",null,{tags:["Advanced"]}),l.prototype.publish("forceDirectedFriction",.9,"number","Friction coefficient",null,{tags:["Advanced"]}),l.prototype.publish("forceDirectedCharge",-25,"number","Charge strength ",null,{tags:["Advanced"]}),l.prototype.publish("forceDirectedChargeDistance",1e4,"number","Maximum distance over which charge forces are applied",null,{tags:["Advanced"]}),l.prototype.publish("forceDirectedTheta",.8,"number","Barnes–Hut approximation criterion",null,{tags:["Advanced"]}),l.prototype.publish("forceDirectedGravity",.1,"number","Gravitational strength",null,{tags:["Advanced"]}),l.prototype.getOffsetPos=function(){return{x:0,y:0}},l.prototype.size=function(t){var o=e.prototype.size.apply(this,arguments);return arguments.length&&this._svgZoom&&this._svgZoom.attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),o},l.prototype.clear=function(){this.data({vertices:[],edges:[],hierarchy:[],merge:!1})},l.prototype.data=function(t){var o=e.prototype.data.apply(this,arguments);if(arguments.length){this.data().merge||(this.graphData=new a,this._renderCount=0);var i=this.graphData.setData(this.data().vertices||[],this.data().edges||[],this.data().hierarchy||[],this.data().merge||!1),r=this;i.addedVertices.forEach(function(t){t._graphID=r._id,t.pos({x:10*+Math.random()/2-5,y:10*+Math.random()/2-5})}),i.addedEdges.forEach(function(t){t._graphID=r._id});var n={};this.graphData.edgeValues().forEach(function(t){n[t._sourceVertex._id]||(n[t._sourceVertex._id]={}),n[t._sourceVertex._id][t._targetVertex._id]||(n[t._sourceVertex._id][t._targetVertex._id]=0);var e=++n[t._sourceVertex._id][t._targetVertex._id];t.arcDepth(16*e)})}return o},l.prototype.selection=function(t){return arguments.length?(this._selection.set(t),this):this._selection.get()},l.prototype.setZoom=function(t,e,o){this.zoom&&(this.zoom.translate(t),this.zoom.scale(e),this.applyZoom(o))},l.prototype.applyZoom=function(e){t.event&&t.event.sourceEvent&&t.event.sourceEvent.ctrlKey&&("wheel"===t.event.sourceEvent.type||"mousewheel"===t.event.sourceEvent.type||"DOMMouseScroll"===t.event.sourceEvent.type)&&t.event.sourceEvent.wheelDelta&&(this.zoom.translate([this.prevTranslate[0],this.prevTranslate[1]+t.event.sourceEvent.wheelDelta]),this.zoom.scale(this.prevScale)),(e?this.svg.transition().duration(e):this.svg).attr("transform","translate("+this.zoom.translate()+")scale("+this.zoom.scale()+")"),this.prevTranslate=this.zoom.translate(),this.prevScale!==this.zoom.scale()&&(this._fixIEMarkers(),this.prevScale=this.zoom.scale()),this.brush.x(t.scale.identity().domain([1*(-this.prevTranslate[0]-this._size.width/2)/this.zoom.scale(),1*(-this.prevTranslate[0]+this._size.width/2)/this.zoom.scale()])),this.brush.y(t.scale.identity().domain([1*(-this.prevTranslate[1]-this._size.height/2)/this.zoom.scale(),1*(-this.prevTranslate[1]+this._size.height/2)/this.zoom.scale()]))},l.prototype.linkcolor_default=function(t){return arguments.length?(this._linkcolor=t,this):this._linkcolor},l.prototype.linktooltip_default=function(t){return arguments.length?(this._linktooltip=t,this):this._linktooltip},l.prototype.enter=function(o,i){function r(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),s._dragging=!0,s.forceLayout){var o=s.forceLayout.vertexMap[e.id()];o.fixed=!0}s.svgMarkerGlitch&&s.graphData.nodeEdges(e.id()).forEach(function(t){var e=s.graphData.edge(t);s._pushMarkers(e.element(),e)})}}function n(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),e.move({x:t.event.x,y:t.event.y}),s.forceLayout){var o=s.forceLayout.vertexMap[e.id()];o.fixed=!0,o.x=o.px=t.event.x,o.y=o.py=t.event.y}s.refreshIncidentEdges(e,!0)}}function a(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),s._dragging=!1,s.snapToGrid()){var o=e.calcSnap(s.snapToGrid());e.move(o[0]),s.refreshIncidentEdges(e,!0)}if(s.forceLayout){var i=s.forceLayout.vertexMap[e.id()];i.fixed=!1}s.svgMarkerGlitch&&s.graphData.nodeEdges(e.id()).forEach(function(t){var e=s.graphData.edge(t);s._popMarkers(e.element(),e)})}}e.prototype.enter.apply(this,arguments);var s=this;this.prevTranslate=[0,0],this.prevScale=1,this.zoom=t.behavior.zoom().scaleExtent([.01,4]).on("zoomstart",function(e){switch(s.prevTranslate=s.zoom.translate(),s.prevScale=s.zoom.scale(),t.event.sourceEvent&&t.event.sourceEvent.shiftKey&&t.event.sourceEvent.ctrlKey?s._zoomMode="selection":t.event.sourceEvent&&t.event.sourceEvent.shiftKey?(s._zoomMode="selection",s._selection.clear()):s._zoomMode="zoom",s._zoomMode){case"selection":i.select(".extent").style("visibility",null);break;default:i.select(".extent").style("visibility","hidden")}}).on("zoomend",function(t){switch(s._zoomMode){case"selection":s.zoom.translate(s.prevTranslate),s.zoom.scale(s.prevScale)}s._svgBrush.call(s.brush.clear())}).on("zoom",function(t){switch(s._zoomMode){case"selection":break;default:s.applyZoom()}}),this.brush=t.svg.brush().x(t.scale.identity().domain([-s._size.width/2,s._size.width/2])).y(t.scale.identity().domain([-s._size.height/2,s._size.height/2])).on("brushstart",function(t){switch(s._zoomMode){case"selection":}}).on("brushend",function(e){switch(s._zoomMode){case"selection":var o=t.event.target.extent();s.svgV.selectAll(".graphVertex").select("*").each(function(t){o[0][0]<=t.x()&&t.x()<o[1][0]&&o[0][1]<=t.y()&&t.y()<o[1][1]&&s._selection.append(t)}),s.graph_selection(s.selection())}}).on("brush",function(){switch(s._zoomMode){case"selection":var e=s.zoom.translate();console.log(e[0]);var o=t.event.target.extent();s.svgV.selectAll(".graphVertex").select("*").classed("selected",function(t){return s._selection.isSelected(t)||o[0][0]<=t.x()&&t.x()<o[1][0]&&o[0][1]<=t.y()&&t.y()<o[1][1]})}}),this.drag=t.behavior.drag().origin(function(t){return t.pos()}).on("dragstart",r).on("dragend",a).on("drag",n),this._svgZoom=i.append("rect").attr("class","zoom").attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),this.defs=i.append("defs"),this.addMarkers(),i.call(this.zoom),this.svg=i.append("g"),this._svgBrush=this.svg.append("g").attr("class","selectionBrush").call(this.brush),this._svgBrush.select(".background").style("cursor",null),s._svgBrush.call(s.brush.clear()),this.svgC=this.svg.append("g").attr("id",this._id+"C"),this.svgE=this.svg.append("g").attr("id",this._id+"E"),this.svgV=this.svg.append("g").attr("id",this._id+"V")},l.prototype.getBounds=function(t,e){var o=[[null,null],[null,null]];return t.forEach(function(t){var i=e?e.nodePos(t._id):{x:t.x(),y:t.y(),width:t.width(),height:t.height()};if(i){var r=i.x-i.width/2,n=i.x+i.width/2,a=i.y-i.height/2,s=i.y+i.height/2;(null===o[0][0]||o[0][0]>r)&&(o[0][0]=r),(null===o[0][1]||o[0][1]>a)&&(o[0][1]=a),(null===o[1][0]||o[1][0]<n)&&(o[1][0]=n),(null===o[1][1]||o[1][1]<s)&&(o[1][1]=s)}}),o},l.prototype.getVertexBounds=function(t){return this.getBounds(this.graphData.nodeValues(),t)},l.prototype.getSelectionBounds=function(t){return this.getBounds(this._selection.get(),t)},l.prototype.shrinkToFit=function(t,e){var o=this.width(),i=this.height(),r=t[1][0]-t[0][0],n=t[1][1]-t[0][1],a=(t[0][0]+t[1][0])/2,s=(t[0][1]+t[1][1])/2,h=1/Math.max(r/o,n/i);h>1&&(h=1);var l=[-h*a,-h*s];this.setZoom(l,h,e)},l.prototype._origScale=l.prototype.scale,l.prototype.scale=function(t,e){var o=l.prototype._origScale.apply(this,arguments);return arguments.length&&this.zoomTo(t,e),o},l.prototype.zoomTo=function(t,e){switch(t){case"all":this.shrinkToFit(this.getVertexBounds(),e);break;case"width":var o=this.getVertexBounds();o[0][1]=0,o[1][1]=0,this.shrinkToFit(o,e);break;case"selection":this.shrinkToFit(this._selection.isEmpty()?this.getVertexBounds():this.getSelectionBounds(),e);break;default:var i=parseInt(t);(isNaN(i)||0>=i||i>200)&&(i=100),this.zoom.scale(i/100),this.applyZoom(e)}},l.prototype.centerOn=function(t,e){var o=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,r=[o,i];this.setZoom(r,1,e)},l.prototype._origLayout=l.prototype.layout,l.prototype.layout=function(t,e){var o=l.prototype._origLayout.apply(this,arguments);if(arguments.length&&this._renderCount){this.forceLayout&&(this.forceLayout.force.stop(),this.forceLayout=null);var i=this,r=this.getLayoutEngine();if("ForceDirected2"===this.layout())this.forceLayout=r,this.forceLayout.force.on("tick",function(t){if(r.vertices.forEach(function(t){if(t.fixed)t.x=t.px,t.y=t.py;else{t.px=t.x,t.py=t.y;var e=i.graphData.node(t.id);e&&e.move({x:t.x,y:t.y})}}),i.graphData.edgeValues().forEach(function(t){t.points([],!1,!1)}),i.applyScaleOnLayout()){var e=i.getVertexBounds(r);i.shrinkToFit(e)}}),this.forceLayout.force.start();else if(r){if(this.forceLayout=null,i._dragging=!0,i.graphData.nodeValues().forEach(function(t){var o=r.nodePos(t._id);t.move({x:o.x,y:o.y},e),o.width&&o.height&&!t.width()&&!t.height()&&t.width(o.width).height(o.height).render()}),i.graphData.edgeValues().forEach(function(t){var o=r.edgePoints(t);t.points(o,e)}),i.applyScaleOnLayout()){var n=i.getVertexBounds(r);i.shrinkToFit(n,e)}this._fixIEMarkers(),setTimeout(function(){i._dragging=!1},e?e+50:50)}}return o},l.prototype.update=function(o,i){function r(t){t.target(this).render(),t.element().call(h.drag),t.dispatch&&(t.dispatch.on("sizestart",function(t,e){t.allowResize(h.allowDragging()),h.allowDragging()&&(h._dragging=!0)}),t.dispatch.on("size",function(t,e){h.refreshIncidentEdges(t,!1)}),t.dispatch.on("sizeend",function(t,e){if(h._dragging=!1,h.snapToGrid()){var o=t.calcSnap(h.snapToGrid());t.pos(o[0]).size(o[1]).render(),h.refreshIncidentEdges(t,!1)}}))}function n(t){t.target(this).render()}function a(t){t.render()}function s(t){t.render()}e.prototype.update.apply(this,arguments);var h=this,l=this.svgV.selectAll("#"+this._id+"V > .graphVertex").data(this.graphData.nodeValues(),function(t){return t.id()});l.enter().append("g").attr("class","graphVertex").style("opacity",1e-6).on("click.selectionBag",function(e){h._selection.click(e,t.event)}).on("click",function(e){var o=t.select(this).select(".graph_Vertex"),i=!1;o.empty()||(i=o.classed("selected")),h.vertex_click(h.rowToObj(e.data()),"",i,{vertex:e})}).on("dblclick",function(e){var o=t.select(this).select(".graph_Vertex"),i=!1;o.empty()||(i=o.classed("selected")),h.vertex_dblclick(h.rowToObj(e.data()),"",i,{vertex:e})}).on("mouseover",function(e){h._dragging||h.vertex_mouseover(t.select(this),e)}).on("mouseout",function(e){h._dragging||h.vertex_mouseout(t.select(this),e)}).each(r).transition().duration(750).style("opacity",1);var c=this.svgE.selectAll("#"+this._id+"E > .graphEdge").data(this.showEdges()?this.graphData.edgeValues():[],function(t){return t.id()});c.enter().append("g").attr("class","graphEdge").style("opacity",1e-6).on("click.selectionBag",function(e){h._selection.click(e,t.event)}).on("click",function(e){var o=t.select(this).select(".graph_Edge"),i=!1;o.empty()||(i=o.classed("selected")),h.edge_click(h.rowToObj(e.data()),"",i,{edge:e})}).on("dblclick",function(e){var o=t.select(this).select(".graph_Edge"),i=!1;o.empty()||(i=o.classed("selected")),h.edge_dblclick(h.rowToObj(e.data()),"",i,{edge:e})}).on("mouseover",function(e){h._dragging||h.edge_mouseover(t.select(this),e)}).on("mouseout",function(e){h._dragging||h.edge_mouseout(t.select(this),e)}).each(n).transition().duration(750).style("opacity",1),l.each(a),c.each(s),l.exit().each(function(t){t.target(null)}).remove(),c.exit().each(function(t){t.target(null)}).remove(),this._renderCount||(this._renderCount++,this.setZoom([0,0],1),this.layout(this.layout()))},l.prototype.getLayoutEngine=function(){switch(this.layout()){case"Circle":return new s.Circle(this.graphData,this._size.width,this._size.height);case"ForceDirected":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{oneShot:!0,linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"ForceDirected2":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"Hierarchy":return new s.Hierarchy(this.graphData,this._size.width,this._size.height,{rankdir:this.hierarchyRankDirection(),nodesep:this.hierarchyNodeSeparation(),edgesep:this.hierarchyEdgeSeparation(),ranksep:this.hierarchyRankSeparation()})}return null},l.prototype.getNeighborMap=function(t){var e={},o={};if(t)for(var i=this.graphData.nodeEdges(t.id()),r=0;r<i.length;++r){var n=this.graphData.edge(i[r]);o[n.id()]=n,n._sourceVertex.id()!==t.id()&&(e[n._sourceVertex.id()]=n._sourceVertex),n._targetVertex.id()!==t.id()&&(e[n._targetVertex.id()]=n._targetVertex)}return{vertices:e,edges:o}},l.prototype.highlightVerticies=function(t){var e=this,o=this.svgV.selectAll(".graphVertex");return o.classed("graphVertex-highlighted",function(e){return!t||t[e.id()]}).transition().duration(this.transitionDuration()).each("end",function(e){t&&t[e.id()]&&e._parentElement.node()&&e._parentElement.node().parentNode&&e._parentElement.node().parentNode.appendChild(e._parentElement.node())}).style("opacity",function(o){return!t||t[o.id()]?1:e.highlight.opacity}),this},l.prototype.highlightEdges=function(t){var e=this,o=this.svgE.selectAll(".graphEdge");return o.classed("graphEdge-highlighted",function(e){return!t||t[e.id()]}).style("stroke-width",function(o){return t&&t[o.id()]?e.highlight.edge:"1px"}).transition().duration(this.transitionDuration()).style("opacity",function(o){return!t||t[o.id()]?1:e.highlight.opacity}),this},l.prototype.highlightVertex=function(t,e){if(this.highlightOnMouseOverVertex())if(e){var o=this.getNeighborMap(e);o.vertices[e.id()]=e,this.highlightVerticies(o.vertices),this.highlightEdges(o.edges)}else this.highlightVerticies(null),this.highlightEdges(null)},l.prototype.highlightEdge=function(t,e){if(this.highlightOnMouseOverEdge())if(e){var o={};o[e._sourceVertex.id()]=e._sourceVertex,o[e._targetVertex.id()]=e._targetVertex;var i={};i[e.id()]=e,this.highlightVerticies(o),this.highlightEdges(i)}else this.highlightVerticies(null),this.highlightEdges(null)},l.prototype.refreshIncidentEdges=function(t,e){var o=this;this.graphData.nodeEdges(t.id()).forEach(function(t){var i=o.graphData.edge(t);i.points([],!1,e)})},l.prototype.graph_selection=function(t){},l.prototype.vertex_click=function(t,e,o,r){r&&r.vertex&&r.vertex._parentElement.node().parentNode.appendChild(r.vertex._parentElement.node()),i.prototype.vertex_click.apply(this,arguments)},l.prototype.vertex_dblclick=function(t,e,o,i){},l.prototype.vertex_mouseover=function(t,e){this.highlightVertex(t,e)},l.prototype.vertex_mouseout=function(t,e){this.highlightVertex(null,null)},l.prototype.edge_mouseover=function(t,e){this.highlightEdge(t,e)},l.prototype.edge_mouseout=function(t,e){this.highlightEdge(null,null)},l.prototype.addMarkers=function(t){t&&(this.defs.select("#"+this._id+"_arrowHead").remove(),
this.defs.select("#"+this._id+"_circleFoot").remove(),this.defs.select("#"+this._id+"_circleHead").remove(),this.defs.select("#"+this._id+"_glow").remove()),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_arrowHead").attr("viewBox","0 0 10 10").attr("refX",10).attr("refY",5).attr("markerWidth",8).attr("markerHeight",8).attr("markerUnits","strokeWidth").attr("orient","auto").append("polyline").attr("points","0,0 10,5 0,10 1,5"),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleFoot").attr("viewBox","0 0 10 10").attr("refX",1).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleHead").attr("viewBox","0 0 10 10").attr("refX",9).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4);var e=this.defs.append("filter").attr("id",this._id+"_glow").attr("width","130%").attr("height","130%");e.append("feOffset").attr("result","offOut").attr("in","SourceGraphic").attr("dx","0").attr("dy","0"),e.append("feColorMatrix").attr("result","matrixOut").attr("in","offOut").attr("type","matrix").attr("values","0.2 0 0 0 0 0 0.2 0 0 1 0 0 0.2 0 0 0 0 0 1 0"),e.append("feGaussianBlur").attr("result","blurOut").attr("in","matrixOut").attr("stdDeviation","3"),e.append("feBlend").attr("in","SourceGraphic").attr("in2","blurOut").attr("mode","normal")},l}),function(t,e){"function"==typeof define&&define.amd?define("graph/VertexC.js",["d3","../common/CanvasWidget","../common/Icon","../common/TextBox"],e):t.graph_VertexC=e(t.d3,t.common_CanvasWidget,t.common_Icon,t.common_TextBox)}(this,function(t,e,o,i){function r(){e.call(this),this.poly_arr=[],this._icon=new o,this._textBox=new i,this._annotationWidgets={}}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype._class+=" graph_VertexC",r.prototype.publishProxy("faChar","_icon"),r.prototype.publishProxy("imageUrl","_icon"),r.prototype.publishProxy("icon_shape_diameter","_icon","diameter"),r.prototype.publishProxy("icon_shape_colorFill","_icon","shape_colorFill"),r.prototype.publishProxy("icon_shape_colorStroke","_icon","shape_colorStroke"),r.prototype.publishProxy("icon_image_colorFill","_icon","image_colorFill"),r.prototype.publish("centroid",!1,"boolean","Centroid Vertex"),r.prototype.publish("centroidGlowSize",20,"number","Centroid Vertex glow size"),r.prototype.publish("centroidGlowColor","#ED1C24","html-color","Centroid Vertex glow color"),r.prototype.publishProxy("text","_textBox"),r.prototype.publishProxy("anchor","_textBox"),r.prototype.publishProxy("textbox_shape_colorStroke","_textBox","shape_colorStroke"),r.prototype.publishProxy("textbox_shape_colorFill","_textBox","shape_colorFill"),r.prototype.publishProxy("textbox_text_colorFill","_textBox","text_colorFill"),r.prototype.publish("iconAnchor","start","set","Icon Anchor Position",["","start","middle","end"],{tags:["Basic"]}),r.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),r.prototype.publish("iconTooltip","","string","iconTooltip",null,{tags:["Private"]}),r.prototype.publish("annotationDiameter",14,"number","Annotation Diameter",null,{tags:["Private"]}),r.prototype.publish("annotationSpacing",3,"number","Annotation Spacing",null,{tags:["Private"]}),r.prototype.publish("annotationIcons",[],"array","Annotations",null,{tags:["Private"]}),r.prototype.drawOriginalLayout=function(t,e){},r.prototype.drawCenteredLayout=function(t,e){},r.prototype.drawKeyLayout=function(t,e){function o(e){var o={vertex:s,tooltip:s.iconTooltip()},i=m,r=h-i,c=l-m/2;t.font=g+"px "+u,s.centroid()&&n(),t.beginPath(),t.font=g+"px "+u,t.rect(r-w,c,i,m),s.poly_arr.push([r-w,c,i,m,o]),t.strokeStyle=s.icon_shape_colorStroke()?s.icon_shape_colorStroke():"#777",t.stroke(),t.fillStyle=s.icon_shape_colorFill()?s.icon_shape_colorFill():"#fff",t.fill(),t.fillStyle=s.icon_image_colorFill()?s.icon_image_colorFill():"#fff",t.textAlign="center",a(),t.fillText(e,r+i/2-w,c+y+f),t.closePath(),s.update_x_minmax(r),s.update_x_minmax(r+i),s.update_y_minmax(c),s.update_y_minmax(c+m)}function i(e){var o={vertex:s,tooltip:s.tooltip()},i=h,r=l-m/2;s.centroid()&&n(),t.beginPath(),t.strokeStyle=s.textbox_shape_colorStroke()?s.textbox_shape_colorStroke():"#777",t.font=d+"px "+p,_=t.measureText(e).width,b=h-m+(m+_)/2,w=b-h,t.rect(i-w,r,_+2*y,x),s.poly_arr.push([i-w,r,_+2*y,x,o]),t.fillStyle=s.textbox_shape_colorFill()?s.textbox_shape_colorFill():"#fff",t.fill(),t.fillStyle=s.textbox_text_colorFill()?s.textbox_text_colorFill():"#000",t.textAlign="left",a(),t.fillText(e,i+y-w,r+y),t.stroke(),t.closePath(),s.update_x_minmax(i),s.update_x_minmax(i+_+2*y),s.update_y_minmax(r),s.update_y_minmax(r+x)}function r(){var e=h+_+2*y-v,o=l,i=0;t.textAlign="left",t.font=d+"px FontAwesome",s.annotationIcons().forEach(function(r){var h={vertex:s,tooltip:r.tooltip,direction:"down"};t.font=d+"px "+r.font,s.centroid()&&n(),t.beginPath(),t.strokeStyle="#777",t.rect(e-i-w,o,v,v),s.poly_arr.push([e-i-w,o,v,v,h]),t.stroke(),t.fillStyle=r.shape_colorFill?r.shape_colorFill:"#fff",t.fill(),t.fillStyle=r.image_colorFill?r.image_colorFill:"#000",a(),t.fillText(r.faChar,e-i+y-w,o+y),t.closePath(),i+=v})}function n(){t.shadowBlur=s.centroidGlowSize(),t.shadowColor=s.centroidGlowColor()}function a(){t.shadowBlur=0}var s=this,h=this.x(),l=this.y(),c=1,p="Arial",u="FontAwesome",d=12*c,g=2*d,y=d/4,f=y,_=0,x=d+2*y,m=2*x,v=x,b=0,w=0;this.min_x=h,this.max_x=h,this.min_y=l,this.max_y=l,t.textBaseline="top",i(this.text()),o(this.faChar()),r(),this.size({height:this.max_y-this.min_y,width:this.max_x-this.min_x})},r.prototype.drawPolyTooltip=function(t,e){function o(t,o,i,r){e.textBaseline="bottom";var n=14;e.font=n+"px Arial";var a=4,s=e.measureText(i).width,h=16,l=10,c=s+2*a,p=n+2*a;r&&(l*=-1,p*=-1),e.fillStyle="#000",e.beginPath(),e.moveTo(t,o),e.lineTo(t-h/2,o-l),e.lineTo(t-c/2,o-l),e.lineTo(t-c/2,o-(l+p)),e.lineTo(t+c/2,o-(l+p)),e.lineTo(t+c/2,o-l),e.lineTo(t+h/2,o-l),e.lineTo(t,o),e.closePath(),e.fill(),e.fillStyle="#FFF",r?e.fillText(i,t-c/2+a,o-l+a+n):e.fillText(i,t-c/2+a,o-l-a)}if(t[4].tooltip){var i=t[0]+t[2]/2,r=t[1]+t[3]/2,n=t[4].direction?t[4].direction:"up";switch(n){case"up":o(i,r,t[4].tooltip);break;case"down":o(i,r,t[4].tooltip,!0)}}},r.prototype.drawSelf=function(t,e){this.poly_arr=[],this.drawKeyLayout(t,e)},r.prototype.getHoveredPolygons=function(t,e){return this.poly_arr.filter(function(o){var i=t>o[0]&&t<o[0]+o[2],r=e>o[1]&&e<o[1]+o[3];return i&&r})},r.prototype.update_x_minmax=function(t){this.min_x>t&&(this.min_x=t),this.max_x<t&&(this.max_x=t)},r.prototype.update_y_minmax=function(t){this.min_y>t&&(this.min_y=t),this.max_y<t&&(this.max_y=t)},r.prototype.getBBox=function(){return this.size()},r}),function(t,e){"function"==typeof define&&define.amd?define("graph/GraphC.js",["d3","../common/CanvasWidget","../common/Palette","../api/IGraph","./VertexC","./EdgeC","./GraphData","./GraphLayouts","../common/Utility"],e):t.graph_Graph=e(t.d3,t.common_CanvasWidget,t.common_Palette,t.api_IGraph,t.graph_VertexC,t.graph_EdgeC,t.graph_GraphData,t.graph_GraphLayouts,t.common_Utility)}(this,function(t,e,o,i,r,n,a,s,h){function l(){e.call(this),i.call(this),this.graphData=new a,this.highlight={zoom:1.1,opacity:.33,edge:"1.25px"},this._selection=new h.Selection,this.log=[],this._translate={x:0,y:0},this._scale={k:1}}return l.prototype=Object.create(e.prototype),l.prototype.constructor=l,l.prototype._class+=" graph_GraphC",l.prototype["implements"](i.prototype),l.prototype.Vertex=r,l.prototype.Edge=n,l.prototype.publish("allowDragging",!0,"boolean","Allow Dragging of Vertices"),l.prototype.publish("layout","Circle","set","Default Layout",["Circle","ForceDirected","ForceDirected2","Hierarchy","None"]),l.prototype.publish("scale","100%","set","Zoom Level",["all","width","selection","100%","90%","75%","50%","25%","10%"]),l.prototype.publish("applyScaleOnLayout",!1,"boolean","Shrink to fit on Layout"),l.prototype.publish("highlightOnMouseOverVertex",!1,"boolean","Highlight Vertex on Mouse Over"),l.prototype.publish("highlightOnMouseOverEdge",!1,"boolean","Highlight Edge on Mouse Over"),l.prototype.publish("transitionDuration",250,"number","Transition Duration"),l.prototype.publish("showEdges",!0,"boolean","Show Edges"),l.prototype.publish("snapToGrid",0,"number","Snap to Grid"),l.prototype.publish("hierarchyRankDirection","TB","set","Direction for Rank Nodes",["TB","BT","LR","RL"]),l.prototype.publish("hierarchyNodeSeparation",50,"number","Number of pixels that separate nodes horizontally in the layout"),l.prototype.publish("hierarchyEdgeSeparation",10,"number","Number of pixels that separate edges horizontally in the layout"),l.prototype.publish("hierarchyRankSeparation",50,"number","Number of pixels between each rank in the layout"),l.prototype.publish("forceDirectedLinkDistance",300,"number","Target distance between linked nodes"),l.prototype.publish("forceDirectedLinkStrength",1,"number","Strength (rigidity) of links"),l.prototype.publish("forceDirectedFriction",.9,"number","Friction coefficient"),l.prototype.publish("forceDirectedCharge",-25,"number","Charge strength "),l.prototype.publish("forceDirectedChargeDistance",1e4,"number","Maximum distance over which charge forces are applied"),l.prototype.publish("forceDirectedTheta",.8,"number","Barnes–Hut approximation criterion"),l.prototype.publish("forceDirectedGravity",.1,"number","Gravitational strength"),l.prototype.draw=function(){null!==this.element().node()&&(this.clearCanvas(),this.drawLinks(),this.drawNodes())},l.prototype.drawNodes=function(){var t=this;this.graphData.nodeValues().forEach(function(e){e.drawSelf(t.ctx,t.element().node())})},l.prototype.drawLinks=function(){var t=this;this.graphData.edgeValues().forEach(function(e){e.drawSelf(t.ctx,t.element().node())})},l.prototype.clearCanvas=function(t,e,o,i){var r=this;if("undefined"!=typeof t)r.ctx.clearRect(t,e,o,i);else{var n=r.element().node(),a=this.zoom.scale(),s=n.width/a,h=n.height/a;r.ctx.clearRect(10*-s,10*-h,10*s*2,10*h*2)}},l.prototype.getOffsetPos=function(){return{x:0,y:0}},l.prototype.size=function(t){var o=e.prototype.size.apply(this,arguments);return arguments.length&&this._svgZoom&&this._svgZoom.attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),o},l.prototype.clear=function(){this.data({vertices:[],edges:[],hierarchy:[],merge:!1})},l.prototype.data=function(t){var o=e.prototype.data.apply(this,arguments);if(arguments.length){this.data().merge||(this.graphData=new a,this._renderCount=0);var i=this.graphData.setData(this.data().vertices||[],this.data().edges||[],this.data().hierarchy||[],this.data().merge||!1),r=this;i.addedVertices.forEach(function(t){t._graphID=r._id,t.pos({x:10*+Math.random()/2-5,y:10*+Math.random()/2-5})}),i.addedEdges.forEach(function(t){t._graphID=r._id});var n={};this.graphData.edgeValues().forEach(function(t){n[t._sourceVertex._id]||(n[t._sourceVertex._id]={}),n[t._sourceVertex._id][t._targetVertex._id]||(n[t._sourceVertex._id][t._targetVertex._id]=0);var e=++n[t._sourceVertex._id][t._targetVertex._id];t.arcDepth(16*e)}),this.ctx&&this.ctx.setTransform(1,0,0,1,0,0),this.draw()}return o},l.prototype.selection=function(t){return arguments.length?(this._selection.set(t),this):this._selection.get()},l.prototype.setZoom=function(t,e,o){this.zoom&&(this.zoom.translate(t),this.zoom.scale(e),this.applyZoom(o))},l.prototype.applyZoom=function(e){var o=t.event&&("wheel"===t.event.sourceEvent.type||"mousewheel"===t.event.sourceEvent.type||"DOMMouseScroll"===t.event.sourceEvent.type);t.event&&t.event.sourceEvent&&t.event.sourceEvent.ctrlKey&&o&&t.event.sourceEvent.wheelDelta&&(this.zoom.translate([this.prevTranslate[0],this.prevTranslate[1]+t.event.sourceEvent.wheelDelta]),this.zoom.scale(this.prevScale));var i=this.zoom.translate();i[0]+=this._size.width/2,i[1]+=this._size.height/2,this._translate=i;var r=this.zoom.scale(),n=!this.prevTranslate||this.prevTranslate[0]!==i[0]||this.prevTranslate[1]!==i[1],a=this.prevScale!==this.zoom.scale();(n||a)&&(this.ctx.setTransform(1,0,0,1,i[0],i[1]),this.ctx.scale(r,r)),this.prevTranslate=this.zoom.translate(),this.prevScale!==this.zoom.scale()&&(this.prevScale=this.zoom.scale())},l.prototype.linkcolor_default=function(t){return arguments.length?(this._linkcolor=t,this):this._linkcolor},l.prototype.linktooltip_default=function(t){return arguments.length?(this._linktooltip=t,this):this._linktooltip},l.prototype.enter=function(o,i){e.prototype.enter.apply(this,arguments);var r=this;i.on("click",function(){var e=(t.event.layerX-r._translate[0])/r.zoom.scale(),o=(t.event.layerY-r._translate[1])/r.zoom.scale();r.data().vertices.forEach(function(t){var i=t.getHoveredPolygons(e,o);i.length>0&&r.vertex_click(r.rowToObj(t.data(),"",!0,{vertex:t}))})}),i.on("dblclick",function(){var e=(t.event.layerX-r._translate[0])/r.zoom.scale(),o=(t.event.layerY-r._translate[1])/r.zoom.scale();r.data().vertices.forEach(function(t){var i=t.getHoveredPolygons(e,o);i.length>0&&r.vertex_dblclick(r.rowToObj(t.data(),"",!0,{vertex:t}))})}),i.on("mousemove",function(){if("undefined"!=typeof r.data().vertices){var e=r.ctx;r.draw();var o=(t.event.layerX-r._translate[0])/r.zoom.scale(),i=(t.event.layerY-r._translate[1])/r.zoom.scale();r.data().vertices.forEach(function(t){var r=t.getHoveredPolygons(o,i);r.length>0&&r.forEach(function(t){t[4].vertex.drawPolyTooltip(t,e)})})}}),this.prevTranslate=[0,0],this.prevScale=1,this.zoom=t.behavior.zoom().scaleExtent([.01,4]).on("zoomstart",function(e){if(!r.draggedVertex)switch(r.prevTranslate=r.zoom.translate(),r.prevScale=r.zoom.scale(),t.event.sourceEvent&&t.event.sourceEvent.shiftKey&&t.event.sourceEvent.ctrlKey?r._zoomMode="selection":t.event.sourceEvent&&t.event.sourceEvent.shiftKey?(r._zoomMode="selection",r._selection.clear()):r._zoomMode="zoom",r._zoomMode){case"selection":i.select(".extent").style("visibility",null);break;default:i.select(".extent").style("visibility","hidden")}}).on("zoomend",function(t){if(!r.draggedVertex)switch(r._zoomMode){case"selection":r.zoom.translate(r.prevTranslate),r.zoom.scale(r.prevScale)}}).on("zoom",function(t){if(!r.draggedVertex){switch(r._zoomMode){case"selection":break;default:r.applyZoom()}r.draw()}}),this.drag=t.behavior.drag().on("dragstart",function(e){if("undefined"!=typeof r.data().vertices){var o=(t.event.sourceEvent.layerX-r._translate[0])/r.zoom.scale(),i=(t.event.sourceEvent.layerY-r._translate[1])/r.zoom.scale();r.data().vertices.forEach(function(t){var e=t.getHoveredPolygons(o,i);e.length>0&&e.forEach(function(t){r.draggedVertex=t[4].vertex})})}}).on("drag",function(e){if(r.draggedVertex){var o=(t.event.sourceEvent.layerX-r._translate[0])/r.zoom.scale(),i=(t.event.sourceEvent.layerY-r._translate[1])/r.zoom.scale();r.draggedVertex.x(o),r.draggedVertex.y(i)}}).on("dragend",function(t){r.draggedVertex&&delete r.draggedVertex}),i.attr("width",this._size.width).attr("height",this._size.height),this.ctx=o.getContext("2d"),i.call(this.zoom),i.call(this.drag),this.draw(),setTimeout(function(){r.draw()},1e3)},l.prototype.getBounds=function(t,e){var o=[[null,null],[null,null]];return t.forEach(function(t){var i=e?e.nodePos(t._id):{x:t.x(),y:t.y(),width:t.width(),height:t.height()};if(i){var r=i.x-i.width/2,n=i.x+i.width/2,a=i.y-i.height/2,s=i.y+i.height/2;(null===o[0][0]||o[0][0]>r)&&(o[0][0]=r),(null===o[0][1]||o[0][1]>a)&&(o[0][1]=a),(null===o[1][0]||o[1][0]<n)&&(o[1][0]=n),(null===o[1][1]||o[1][1]<s)&&(o[1][1]=s)}}),o},l.prototype.getVertexBounds=function(t){return this.getBounds(this.graphData.nodeValues(),t)},l.prototype.getSelectionBounds=function(t){return this.getBounds(this._selection.get(),t)},l.prototype.shrinkToFit=function(t,e){var o=this.width(),i=this.height(),r=t[1][0]-t[0][0],n=t[1][1]-t[0][1],a=(t[0][0]+t[1][0])/2,s=(t[0][1]+t[1][1])/2,h=1/Math.max(r/o,n/i);h>1&&(h=1);var l=[-h*a,-h*s];this.setZoom(l,h,e)},l.prototype._origScale=l.prototype.scale,l.prototype.scale=function(t,e){var o=l.prototype._origScale.apply(this,arguments);return arguments.length&&this.zoomTo(t,e),o},l.prototype.zoomTo=function(t,e){switch(t){case"all":this.shrinkToFit(this.getVertexBounds(),e);break;case"width":var o=this.getVertexBounds();o[0][1]=0,o[1][1]=0,this.shrinkToFit(o,e);break;case"selection":this.shrinkToFit(this._selection.isEmpty()?this.getVertexBounds():this.getSelectionBounds(),e);break;default:var i=parseInt(t);(isNaN(i)||0>=i||i>200)&&(i=100),this.zoom.scale(i/100),this.applyZoom(e)}this.draw()},l.prototype.centerOn=function(t,e){var o=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,r=[o,i];this.setZoom(r,1,e)},l.prototype._origLayout=l.prototype.layout,l.prototype.layout=function(t,e){var o=l.prototype._origLayout.apply(this,arguments);if(arguments.length){if(this._renderCount){this.forceLayout&&(this.forceLayout.force.stop(),this.forceLayout=null);var i=this,r=this.getLayoutEngine();if("ForceDirected2"===this.layout())this.forceLayout=r,this.forceLayout.force.on("tick",function(t){if(r.vertices.forEach(function(t){if(t.fixed)t.x=t.px,t.y=t.py;else{t.px=t.x,t.py=t.y;var e=i.graphData.node(t.id);e&&(e.x(t.x),e.y(t.y))}}),i.graphData.edgeValues().forEach(function(t){t.points([],!1,!1)}),i.applyScaleOnLayout()){var e=i.getVertexBounds(r);i.shrinkToFit(e)}i.draw()}),this.forceLayout.force.start();else if(r){if(this.forceLayout=null,i._dragging=!0,i.graphData.nodeValues().forEach(function(t){var e=r.nodePos(t._id);t.x(e.x),t.y(e.y)}),i.graphData.edgeValues().forEach(function(t){var o=r.edgePoints(t);t.points(o,e)}),i.applyScaleOnLayout()){var n=i.getVertexBounds(r);i.shrinkToFit(n,e)}setTimeout(function(){i._dragging=!1},e?e+50:50)}}this.zoomTo("all")}return o},l.prototype.update=function(t,o){e.prototype.update.apply(this,arguments),this._renderCount||(this._renderCount++,this.setZoom([.1,0],1),this.layout(this.layout())),this.clearCanvas(),this.drawLinks(),this.drawNodes()},l.prototype.getLayoutEngine=function(){switch(this.layout()){case"Circle":return new s.Circle(this.graphData,this._size.width,this._size.height);case"ForceDirected":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{oneShot:!0,linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"ForceDirected2":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"Hierarchy":return new s.Hierarchy(this.graphData,this._size.width,this._size.height,{rankdir:this.hierarchyRankDirection(),nodesep:this.hierarchyNodeSeparation(),edgesep:this.hierarchyEdgeSeparation(),ranksep:this.hierarchyRankSeparation()})}return null},l.prototype.resize=function(t){var o=e.prototype.resize.apply(this,arguments);return this.zoomTo("all"),o},l.prototype.graph_selection=function(t){},l.prototype.vertex_click=function(t,e,o,r){r&&r.vertex&&r.vertex._parentElement.node().parentNode.appendChild(r.vertex._parentElement.node()),i.prototype.vertex_click.apply(this,arguments)},l.prototype.vertex_dblclick=function(t,e,o,i){},l.prototype.vertex_mouseover=function(t,e){this.highlightVertex(t,e)},l.prototype.vertex_mouseout=function(t,e){this.highlightVertex(null,null)},l.prototype.edge_mouseover=function(t,e){this.highlightEdge(t,e)},l.prototype.edge_mouseout=function(t,e){this.highlightEdge(null,null)},l}),function(t,e){"function"==typeof define&&define.amd?define("graph/Sankey.js",["d3","../common/SVGWidget","../common/Palette","../common/PropertyExt","../common/Utility","d3-sankey","css!./Sankey"],e):t.graph_Sankey=e(t.d3,t.common_SVGWidget,t.common_Palette,t.common_PropertyExt,t.common_Utility,t.d3.sankey)}(this,function(t,e,o,i,r,n){function a(t){i.call(this),this._owner=t}function s(t){e.call(this),r.SimpleSelectionMixin.call(this),this._drawStartPos="origin"}return n=n||t.sankey||window.d3.sankey,a.prototype=Object.create(i.prototype),a.prototype.constructor=a,a.prototype._class+=" graph_Sankey.Column",a.prototype.publish("column",null,"set","Field",function(){return this._owner?this._owner.columns():[]},{optional:!0}),a.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0,disable:function(t){return!t._owner||0===t._owner.mappings().indexOf(t)}}),a.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this._owner?this._owner.columns():[]},{optional:!0,disable:function(t){return!t._owner||!t.aggrType()||0===t._owner.mappings().indexOf(t)}}),a.prototype.aggregate=function(e){switch(this.aggrType()){case null:case void 0:case"":return e.length;default:var o=this._owner.columns(),i=o.indexOf(this.aggrColumn());return t[this.aggrType()](e,function(t){return+t[i]})}},s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype._class+=" graph_Sankey",s.prototype.Column=a,s.prototype.mixin(r.SimpleSelectionMixin),s.prototype._palette=o.ordinal("default"),s.prototype.publish("paletteID","default","set","Palette ID",s.prototype._palette["switch"]()),s.prototype.publish("mappings",[],"propertyArray","Source Columns",null,{autoExpand:a}),s.prototype.publish("vertexWidth",36,"number","Vertex Width"),s.prototype.publish("vertexPadding",40,"number","Vertex Padding"),s.prototype.publish("xAxisMovement",!1,"boolean","Enable x-axis movement"),s.prototype.publish("yAxisMovement",!1,"boolean","Enable y-axis movement"),s.prototype.sankeyData=function(){var t={},e={vertices:[],edges:[]},o=this.mappings().filter(function(t){return t.column()});return o.forEach(function(o,i){var r=this._db.rollupView([o.column()]);r.entries().forEach(function(r){var n=o.column()+":"+i+":"+r.key;t[n]||(e.vertices.push({__id:n,__category:o.column(),name:r.key,origRow:r.values}),t[n]=e.vertices.length-1)},this)},this),o.forEach(function(i,r){if(r<o.length-1){var n=o[r+1],a=this._db.rollupView([i.column(),n.column()]);a.entries().forEach(function(o){var a=i.column()+":"+r+":"+o.key;o.values.forEach(function(o){var i=n.column()+":"+(r+1)+":"+o.key;e.edges.push({__id:a+"_"+i,source:t[a],target:t[i],value:n.aggregate(o.values)})})})}},this),e},s.prototype.enter=function(t,o){e.prototype.enter.apply(this,arguments),this._d3Sankey=new n,this._d3SankeyPath=this._d3Sankey.link(),this._selection.widgetElement(o)},s.prototype.update=function(o,i){e.prototype.update.apply(this,arguments),this._palette=this._palette["switch"](this.paletteID());var r=this.sankeyData();this._d3Sankey.size([this.width(),this.height()]).nodeWidth(this.vertexWidth()).nodePadding(this.vertexPadding()).nodes(r.vertices).links(r.edges).layout(32);var n=this,a=i.selectAll(".link").data(r.edges);a.enter().append("path").attr("class","link").append("title"),a.attr("d",this._d3SankeyPath).style("stroke-width",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy}),a.select("title").text(function(t){return t.source.name+" → "+t.target.name+"\n"+t.value}),a.exit().remove();var s=i.selectAll(".node").data(r.vertices);s.enter().append("g").attr("class","node").call(this._selection.enter.bind(this._selection)).on("click",function(t,e){n.click(n.rowToObj(t.origRow[0]),"",n._selection.selected(this))}).on("dblclick",function(t,e){n.dblclick(n.rowToObj(t.origRow[0]),"",n._selection.selected(this))}).each(function(e){var o=t.select(this);o.append("rect"),o.append("text")}),s.attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),s.select("rect").attr("height",function(t){return t.dy}).attr("width",this._d3Sankey.nodeWidth()).style("fill",function(t){return n._palette(t.name)}).style("cursor",this.xAxisMovement()||this.yAxisMovement()?null:"default"),s.select("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).filter(function(t){return t.x<n.width()/2}).attr("x",6+this._d3Sankey.nodeWidth()).attr("text-anchor","start"),s.exit().remove()},s.prototype.exit=function(t,o){e.prototype.exit.apply(this,arguments)},s.prototype.click=function(t,e,o){console.log("Click:  "+JSON.stringify(t)+", "+e+","+o)},s.prototype.dblclick=function(t,e,o){console.log("Double Click:  "+JSON.stringify(t)+", "+e+","+o)},s});