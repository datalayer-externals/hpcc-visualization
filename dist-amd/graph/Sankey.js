!function(t,e){"function"==typeof define&&define.amd?define(["d3","../common/SVGWidget","../common/Palette","../common/PropertyExt","../common/Utility","d3-sankey","css!./Sankey"],e):t.graph_Sankey=e(t.d3,t.common_SVGWidget,t.common_Palette,t.common_PropertyExt,t.common_Utility,t.d3.sankey)}(this,function(t,e,n,o,i,r){function a(t){o.call(this),this._owner=t}function s(t){e.call(this),i.SimpleSelectionMixin.call(this),this._drawStartPos="origin"}return r=r||t.sankey||window.d3.sankey,a.prototype=Object.create(o.prototype),a.prototype.constructor=a,a.prototype._class+=" graph_Sankey.Column",a.prototype.publish("column",null,"set","Field",function(){return this._owner?this._owner.columns():[]},{optional:!0}),a.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0,disable:function(t){return!t._owner||0===t._owner.mappings().indexOf(t)}}),a.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this._owner?this._owner.columns():[]},{optional:!0,disable:function(t){return!t._owner||!t.aggrType()||0===t._owner.mappings().indexOf(t)}}),a.prototype.aggregate=function(e){switch(this.aggrType()){case null:case void 0:case"":return e.length;default:var n=this._owner.columns(),o=n.indexOf(this.aggrColumn());return t[this.aggrType()](e,function(t){return+t[o]})}},s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype._class+=" graph_Sankey",s.prototype.Column=a,s.prototype.mixin(i.SimpleSelectionMixin),s.prototype._palette=n.ordinal("default"),s.prototype.publish("paletteID","default","set","Palette ID",s.prototype._palette["switch"]()),s.prototype.publish("mappings",[],"propertyArray","Source Columns",null,{autoExpand:a}),s.prototype.publish("vertexWidth",36,"number","Vertex Width"),s.prototype.publish("vertexPadding",40,"number","Vertex Padding"),s.prototype.publish("xAxisMovement",!1,"boolean","Enable x-axis movement"),s.prototype.publish("yAxisMovement",!1,"boolean","Enable y-axis movement"),s.prototype.sankeyData=function(){var t={},e={vertices:[],edges:[]},n=this.mappings().filter(function(t){return t.column()});return n.forEach(function(n,o){var i=this._db.rollupView([n.column()]);i.entries().forEach(function(i){var r=n.column()+":"+o+":"+i.key;t[r]||(e.vertices.push({__id:r,__category:n.column(),name:i.key,origRow:i.values}),t[r]=e.vertices.length-1)},this)},this),n.forEach(function(o,i){if(i<n.length-1){var r=n[i+1],a=this._db.rollupView([o.column(),r.column()]);a.entries().forEach(function(n){var a=o.column()+":"+i+":"+n.key;n.values.forEach(function(n){var o=r.column()+":"+(i+1)+":"+n.key;e.edges.push({__id:a+"_"+o,source:t[a],target:t[o],value:r.aggregate(n.values)})})})}},this),e},s.prototype.enter=function(t,n){e.prototype.enter.apply(this,arguments),this._d3Sankey=new r,this._d3SankeyPath=this._d3Sankey.link(),this._selection.widgetElement(n)},s.prototype.update=function(n,o){e.prototype.update.apply(this,arguments),this._palette=this._palette["switch"](this.paletteID());var i=this.sankeyData();this._d3Sankey.size([this.width(),this.height()]).nodeWidth(this.vertexWidth()).nodePadding(this.vertexPadding()).nodes(i.vertices).links(i.edges).layout(32);var r=this,a=o.selectAll(".link").data(i.edges);a.enter().append("path").attr("class","link").append("title"),a.attr("d",this._d3SankeyPath).style("stroke-width",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy}),a.select("title").text(function(t){return t.source.name+" â†’ "+t.target.name+"\n"+t.value}),a.exit().remove();var s=o.selectAll(".node").data(i.vertices);s.enter().append("g").attr("class","node").call(this._selection.enter.bind(this._selection)).on("click",function(t,e){r.click(r.rowToObj(t.origRow[0]),"",r._selection.selected(this))}).on("dblclick",function(t,e){r.dblclick(r.rowToObj(t.origRow[0]),"",r._selection.selected(this))}).each(function(e){var n=t.select(this);n.append("rect"),n.append("text")}),s.attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),s.select("rect").attr("height",function(t){return t.dy}).attr("width",this._d3Sankey.nodeWidth()).style("fill",function(t){return r._palette(t.name)}).style("cursor",this.xAxisMovement()||this.yAxisMovement()?null:"default"),s.select("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).filter(function(t){return t.x<r.width()/2}).attr("x",6+this._d3Sankey.nodeWidth()).attr("text-anchor","start"),s.exit().remove()},s.prototype.exit=function(t,n){e.prototype.exit.apply(this,arguments)},s.prototype.click=function(t,e,n){console.log("Click:  "+JSON.stringify(t)+", "+e+","+n)},s.prototype.dblclick=function(t,e,n){console.log("Double Click:  "+JSON.stringify(t)+", "+e+","+n)},s});