!function(t,e){"function"==typeof define&&define.amd?define(["d3","../common/SVGWidget","../common/Palette","../api/IGraph","./Vertex","./Edge","./GraphData","./GraphLayouts","../common/Utility","css!./Graph"],e):t.graph_Graph=e(t.d3,t.common_SVGWidget,t.common_Palette,t.api_IGraph,t.graph_Vertex,t.graph_Edge,t.graph_GraphData,t.graph_GraphLayouts,t.common_Utility)}(this,function(t,e,i,r,o,a,s,n,h){function c(){e.call(this),r.call(this),this.graphData=new s,this.highlight={zoom:1.1,opacity:.33,edge:"1.25px"},this._selection=new h.Selection}return c.prototype=Object.create(e.prototype),c.prototype.constructor=c,c.prototype._class+=" graph_Graph",c.prototype["implements"](r.prototype),c.prototype.Vertex=o,c.prototype.Edge=a,c.prototype.publish("allowDragging",!0,"boolean","Allow Dragging of Vertices",null,{tags:["Advanced"]}),c.prototype.publish("layout","Circle","set","Default Layout",["Circle","ForceDirected","ForceDirected2","Hierarchy","None"],{tags:["Basic"]}),c.prototype.publish("scale","100%","set","Zoom Level",["all","width","selection","100%","90%","75%","50%","25%","10%"],{tags:["Basic"]}),c.prototype.publish("applyScaleOnLayout",!1,"boolean","Shrink to fit on Layout",null,{tags:["Basic"]}),c.prototype.publish("highlightOnMouseOverVertex",!1,"boolean","Highlight Vertex on Mouse Over",null,{tags:["Basic"]}),c.prototype.publish("highlightOnMouseOverEdge",!1,"boolean","Highlight Edge on Mouse Over",null,{tags:["Basic"]}),c.prototype.publish("transitionDuration",250,"number","Transition Duration",null,{tags:["Intermediate"]}),c.prototype.publish("showEdges",!0,"boolean","Show Edges",null,{tags:["Intermediate"]}),c.prototype.publish("snapToGrid",0,"number","Snap to Grid",null,{tags:["Private"]}),c.prototype.publish("hierarchyRankDirection","TB","set","Direction for Rank Nodes",["TB","BT","LR","RL"],{tags:["Advanced"]}),c.prototype.publish("hierarchyNodeSeparation",50,"number","Number of pixels that separate nodes horizontally in the layout",null,{tags:["Advanced"]}),c.prototype.publish("hierarchyEdgeSeparation",10,"number","Number of pixels that separate edges horizontally in the layout",null,{tags:["Advanced"]}),c.prototype.publish("hierarchyRankSeparation",50,"number","Number of pixels between each rank in the layout",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedLinkDistance",300,"number","Target distance between linked nodes",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedLinkStrength",1,"number","Strength (rigidity) of links",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedFriction",.9,"number","Friction coefficient",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedCharge",-25,"number","Charge strength ",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedChargeDistance",1e4,"number","Maximum distance over which charge forces are applied",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedTheta",.8,"number","Barnesâ€“Hut approximation criterion",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedGravity",.1,"number","Gravitational strength",null,{tags:["Advanced"]}),c.prototype.getOffsetPos=function(){return{x:0,y:0}},c.prototype.size=function(t){var i=e.prototype.size.apply(this,arguments);return arguments.length&&this._svgZoom&&this._svgZoom.attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),i},c.prototype.clear=function(){this.data({vertices:[],edges:[],hierarchy:[],merge:!1})},c.prototype.data=function(t){var i=e.prototype.data.apply(this,arguments);if(arguments.length){this.data().merge||(this.graphData=new s,this._renderCount=0);var r=this.graphData.setData(this.data().vertices||[],this.data().edges||[],this.data().hierarchy||[],this.data().merge||!1),o=this;r.addedVertices.forEach(function(t){t._graphID=o._id,t.pos({x:10*+Math.random()/2-5,y:10*+Math.random()/2-5})}),r.addedEdges.forEach(function(t){t._graphID=o._id});var a={};this.graphData.edgeValues().forEach(function(t){a[t._sourceVertex._id]||(a[t._sourceVertex._id]={}),a[t._sourceVertex._id][t._targetVertex._id]||(a[t._sourceVertex._id][t._targetVertex._id]=0);var e=++a[t._sourceVertex._id][t._targetVertex._id];t.arcDepth(16*e)})}return i},c.prototype.selection=function(t){return arguments.length?(this._selection.set(t),this):this._selection.get()},c.prototype.setZoom=function(t,e,i){this.zoom&&(this.zoom.translate(t),this.zoom.scale(e),this.applyZoom(i))},c.prototype.applyZoom=function(e){t.event&&t.event.sourceEvent&&t.event.sourceEvent.ctrlKey&&("wheel"===t.event.sourceEvent.type||"mousewheel"===t.event.sourceEvent.type||"DOMMouseScroll"===t.event.sourceEvent.type)&&t.event.sourceEvent.wheelDelta&&(this.zoom.translate([this.prevTranslate[0],this.prevTranslate[1]+t.event.sourceEvent.wheelDelta]),this.zoom.scale(this.prevScale)),(e?this.svg.transition().duration(e):this.svg).attr("transform","translate("+this.zoom.translate()+")scale("+this.zoom.scale()+")"),this.prevTranslate=this.zoom.translate(),this.prevScale!==this.zoom.scale()&&(this._fixIEMarkers(),this.prevScale=this.zoom.scale()),this.brush.x(t.scale.identity().domain([1*(-this.prevTranslate[0]-this._size.width/2)/this.zoom.scale(),1*(-this.prevTranslate[0]+this._size.width/2)/this.zoom.scale()])),this.brush.y(t.scale.identity().domain([1*(-this.prevTranslate[1]-this._size.height/2)/this.zoom.scale(),1*(-this.prevTranslate[1]+this._size.height/2)/this.zoom.scale()]))},c.prototype.linkcolor_default=function(t){return arguments.length?(this._linkcolor=t,this):this._linkcolor},c.prototype.linktooltip_default=function(t){return arguments.length?(this._linktooltip=t,this):this._linktooltip},c.prototype.enter=function(i,r){function o(e){if(n.allowDragging()){if(t.event.sourceEvent.stopPropagation(),n._dragging=!0,n.forceLayout){var i=n.forceLayout.vertexMap[e.id()];i.fixed=!0}n.svgMarkerGlitch&&n.graphData.nodeEdges(e.id()).forEach(function(t){var e=n.graphData.edge(t);n._pushMarkers(e.element(),e)})}}function a(e){if(n.allowDragging()){if(t.event.sourceEvent.stopPropagation(),e.move({x:t.event.x,y:t.event.y}),n.forceLayout){var i=n.forceLayout.vertexMap[e.id()];i.fixed=!0,i.x=i.px=t.event.x,i.y=i.py=t.event.y}n.refreshIncidentEdges(e,!0)}}function s(e){if(n.allowDragging()){if(t.event.sourceEvent.stopPropagation(),n._dragging=!1,n.snapToGrid()){var i=e.calcSnap(n.snapToGrid());e.move(i[0]),n.refreshIncidentEdges(e,!0)}if(n.forceLayout){var r=n.forceLayout.vertexMap[e.id()];r.fixed=!1}n.svgMarkerGlitch&&n.graphData.nodeEdges(e.id()).forEach(function(t){var e=n.graphData.edge(t);n._popMarkers(e.element(),e)})}}e.prototype.enter.apply(this,arguments);var n=this;this.prevTranslate=[0,0],this.prevScale=1,this.zoom=t.behavior.zoom().scaleExtent([.01,4]).on("zoomstart",function(e){switch(n.prevTranslate=n.zoom.translate(),n.prevScale=n.zoom.scale(),t.event.sourceEvent&&t.event.sourceEvent.shiftKey&&t.event.sourceEvent.ctrlKey?n._zoomMode="selection":t.event.sourceEvent&&t.event.sourceEvent.shiftKey?(n._zoomMode="selection",n._selection.clear()):n._zoomMode="zoom",n._zoomMode){case"selection":r.select(".extent").style("visibility",null);break;default:r.select(".extent").style("visibility","hidden")}}).on("zoomend",function(t){switch(n._zoomMode){case"selection":n.zoom.translate(n.prevTranslate),n.zoom.scale(n.prevScale)}n._svgBrush.call(n.brush.clear())}).on("zoom",function(t){switch(n._zoomMode){case"selection":break;default:n.applyZoom()}}),this.brush=t.svg.brush().x(t.scale.identity().domain([-n._size.width/2,n._size.width/2])).y(t.scale.identity().domain([-n._size.height/2,n._size.height/2])).on("brushstart",function(t){switch(n._zoomMode){case"selection":}}).on("brushend",function(e){switch(n._zoomMode){case"selection":var i=t.event.target.extent();n.svgV.selectAll(".graphVertex").select("*").each(function(t){i[0][0]<=t.x()&&t.x()<i[1][0]&&i[0][1]<=t.y()&&t.y()<i[1][1]&&n._selection.append(t)}),n.graph_selection(n.selection())}}).on("brush",function(){switch(n._zoomMode){case"selection":var e=n.zoom.translate();console.log(e[0]);var i=t.event.target.extent();n.svgV.selectAll(".graphVertex").select("*").classed("selected",function(t){return n._selection.isSelected(t)||i[0][0]<=t.x()&&t.x()<i[1][0]&&i[0][1]<=t.y()&&t.y()<i[1][1]})}}),this.drag=t.behavior.drag().origin(function(t){return t.pos()}).on("dragstart",o).on("dragend",s).on("drag",a),this._svgZoom=r.append("rect").attr("class","zoom").attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),this.defs=r.append("defs"),this.addMarkers(),r.call(this.zoom),this.svg=r.append("g"),this._svgBrush=this.svg.append("g").attr("class","selectionBrush").call(this.brush),this._svgBrush.select(".background").style("cursor",null),n._svgBrush.call(n.brush.clear()),this.svgC=this.svg.append("g").attr("id",this._id+"C"),this.svgE=this.svg.append("g").attr("id",this._id+"E"),this.svgV=this.svg.append("g").attr("id",this._id+"V")},c.prototype.getBounds=function(t,e){var i=[[null,null],[null,null]];return t.forEach(function(t){var r=e?e.nodePos(t._id):{x:t.x(),y:t.y(),width:t.width(),height:t.height()};if(r){var o=r.x-r.width/2,a=r.x+r.width/2,s=r.y-r.height/2,n=r.y+r.height/2;(null===i[0][0]||i[0][0]>o)&&(i[0][0]=o),(null===i[0][1]||i[0][1]>s)&&(i[0][1]=s),(null===i[1][0]||i[1][0]<a)&&(i[1][0]=a),(null===i[1][1]||i[1][1]<n)&&(i[1][1]=n)}}),i},c.prototype.getVertexBounds=function(t){return this.getBounds(this.graphData.nodeValues(),t)},c.prototype.getSelectionBounds=function(t){return this.getBounds(this._selection.get(),t)},c.prototype.shrinkToFit=function(t,e){var i=this.width(),r=this.height(),o=t[1][0]-t[0][0],a=t[1][1]-t[0][1],s=(t[0][0]+t[1][0])/2,n=(t[0][1]+t[1][1])/2,h=1/Math.max(o/i,a/r);h>1&&(h=1);var c=[-h*s,-h*n];this.setZoom(c,h,e)},c.prototype._origScale=c.prototype.scale,c.prototype.scale=function(t,e){var i=c.prototype._origScale.apply(this,arguments);return arguments.length&&this.zoomTo(t,e),i},c.prototype.zoomTo=function(t,e){switch(t){case"all":this.shrinkToFit(this.getVertexBounds(),e);break;case"width":var i=this.getVertexBounds();i[0][1]=0,i[1][1]=0,this.shrinkToFit(i,e);break;case"selection":this.shrinkToFit(this._selection.isEmpty()?this.getVertexBounds():this.getSelectionBounds(),e);break;default:var r=parseInt(t);(isNaN(r)||0>=r||r>200)&&(r=100),this.zoom.scale(r/100),this.applyZoom(e)}},c.prototype.centerOn=function(t,e){var i=(t[0][0]+t[1][0])/2,r=(t[0][1]+t[1][1])/2,o=[i,r];this.setZoom(o,1,e)},c.prototype._origLayout=c.prototype.layout,c.prototype.layout=function(t,e){var i=c.prototype._origLayout.apply(this,arguments);if(arguments.length&&this._renderCount){this.forceLayout&&(this.forceLayout.force.stop(),this.forceLayout=null);var r=this,o=this.getLayoutEngine();if("ForceDirected2"===this.layout())this.forceLayout=o,this.forceLayout.force.on("tick",function(t){if(o.vertices.forEach(function(t){if(t.fixed)t.x=t.px,t.y=t.py;else{t.px=t.x,t.py=t.y;var e=r.graphData.node(t.id);e&&e.move({x:t.x,y:t.y})}}),r.graphData.edgeValues().forEach(function(t){t.points([],!1,!1)}),r.applyScaleOnLayout()){var e=r.getVertexBounds(o);r.shrinkToFit(e)}}),this.forceLayout.force.start();else if(o){if(this.forceLayout=null,r._dragging=!0,r.graphData.nodeValues().forEach(function(t){var i=o.nodePos(t._id);t.move({x:i.x,y:i.y},e),i.width&&i.height&&!t.width()&&!t.height()&&t.width(i.width).height(i.height).render()}),r.graphData.edgeValues().forEach(function(t){var i=o.edgePoints(t);t.points(i,e)}),r.applyScaleOnLayout()){var a=r.getVertexBounds(o);r.shrinkToFit(a,e)}this._fixIEMarkers(),setTimeout(function(){r._dragging=!1},e?e+50:50)}}return i},c.prototype.update=function(i,r){function o(t){t.target(this).render(),t.element().call(h.drag),t.dispatch&&(t.dispatch.on("sizestart",function(t,e){t.allowResize(h.allowDragging()),h.allowDragging()&&(h._dragging=!0)}),t.dispatch.on("size",function(t,e){h.refreshIncidentEdges(t,!1)}),t.dispatch.on("sizeend",function(t,e){if(h._dragging=!1,h.snapToGrid()){var i=t.calcSnap(h.snapToGrid());t.pos(i[0]).size(i[1]).render(),h.refreshIncidentEdges(t,!1)}}))}function a(t){t.target(this).render()}function s(t){t.render()}function n(t){t.render()}e.prototype.update.apply(this,arguments);var h=this,c=this.svgV.selectAll("#"+this._id+"V > .graphVertex").data(this.graphData.nodeValues(),function(t){return t.id()});c.enter().append("g").attr("class","graphVertex").style("opacity",1e-6).on("click.selectionBag",function(e){h._selection.click(e,t.event)}).on("click",function(e){var i=t.select(this).select(".graph_Vertex"),r=!1;i.empty()||(r=i.classed("selected")),h.vertex_click(h.rowToObj(e.data()),"",r,{vertex:e})}).on("dblclick",function(e){var i=t.select(this).select(".graph_Vertex"),r=!1;i.empty()||(r=i.classed("selected")),h.vertex_dblclick(h.rowToObj(e.data()),"",r,{vertex:e})}).on("mouseover",function(e){h._dragging||h.vertex_mouseover(t.select(this),e)}).on("mouseout",function(e){h._dragging||h.vertex_mouseout(t.select(this),e)}).each(o).transition().duration(750).style("opacity",1);var l=this.svgE.selectAll("#"+this._id+"E > .graphEdge").data(this.showEdges()?this.graphData.edgeValues():[],function(t){return t.id()});l.enter().append("g").attr("class","graphEdge").style("opacity",1e-6).on("click.selectionBag",function(e){h._selection.click(e,t.event)}).on("click",function(e){var i=t.select(this).select(".graph_Edge"),r=!1;i.empty()||(r=i.classed("selected")),h.edge_click(h.rowToObj(e.data()),"",r,{edge:e})}).on("dblclick",function(e){var i=t.select(this).select(".graph_Edge"),r=!1;i.empty()||(r=i.classed("selected")),h.edge_dblclick(h.rowToObj(e.data()),"",r,{edge:e})}).on("mouseover",function(e){h._dragging||h.edge_mouseover(t.select(this),e)}).on("mouseout",function(e){h._dragging||h.edge_mouseout(t.select(this),e)}).each(a).transition().duration(750).style("opacity",1),c.each(s),l.each(n),c.exit().each(function(t){t.target(null)}).remove(),l.exit().each(function(t){t.target(null)}).remove(),this._renderCount||(this._renderCount++,this.setZoom([0,0],1),this.layout(this.layout()))},c.prototype.getLayoutEngine=function(){switch(this.layout()){case"Circle":return new n.Circle(this.graphData,this._size.width,this._size.height);case"ForceDirected":return new n.ForceDirected(this.graphData,this._size.width,this._size.height,{oneShot:!0,linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"ForceDirected2":return new n.ForceDirected(this.graphData,this._size.width,this._size.height,{linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"Hierarchy":return new n.Hierarchy(this.graphData,this._size.width,this._size.height,{rankdir:this.hierarchyRankDirection(),nodesep:this.hierarchyNodeSeparation(),edgesep:this.hierarchyEdgeSeparation(),ranksep:this.hierarchyRankSeparation()})}return null},c.prototype.getNeighborMap=function(t){var e={},i={};if(t)for(var r=this.graphData.nodeEdges(t.id()),o=0;o<r.length;++o){var a=this.graphData.edge(r[o]);i[a.id()]=a,a._sourceVertex.id()!==t.id()&&(e[a._sourceVertex.id()]=a._sourceVertex),a._targetVertex.id()!==t.id()&&(e[a._targetVertex.id()]=a._targetVertex)}return{vertices:e,edges:i}},c.prototype.highlightVerticies=function(t){var e=this,i=this.svgV.selectAll(".graphVertex");return i.classed("graphVertex-highlighted",function(e){return!t||t[e.id()]}).transition().duration(this.transitionDuration()).each("end",function(e){t&&t[e.id()]&&e._parentElement.node()&&e._parentElement.node().parentNode&&e._parentElement.node().parentNode.appendChild(e._parentElement.node())}).style("opacity",function(i){return!t||t[i.id()]?1:e.highlight.opacity}),this},c.prototype.highlightEdges=function(t){var e=this,i=this.svgE.selectAll(".graphEdge");return i.classed("graphEdge-highlighted",function(e){return!t||t[e.id()]}).style("stroke-width",function(i){return t&&t[i.id()]?e.highlight.edge:"1px"}).transition().duration(this.transitionDuration()).style("opacity",function(i){return!t||t[i.id()]?1:e.highlight.opacity}),this},c.prototype.highlightVertex=function(t,e){if(this.highlightOnMouseOverVertex())if(e){var i=this.getNeighborMap(e);i.vertices[e.id()]=e,this.highlightVerticies(i.vertices),this.highlightEdges(i.edges)}else this.highlightVerticies(null),this.highlightEdges(null)},c.prototype.highlightEdge=function(t,e){if(this.highlightOnMouseOverEdge())if(e){var i={};i[e._sourceVertex.id()]=e._sourceVertex,i[e._targetVertex.id()]=e._targetVertex;var r={};r[e.id()]=e,this.highlightVerticies(i),this.highlightEdges(r)}else this.highlightVerticies(null),this.highlightEdges(null)},c.prototype.refreshIncidentEdges=function(t,e){var i=this;this.graphData.nodeEdges(t.id()).forEach(function(t){var r=i.graphData.edge(t);r.points([],!1,e)})},c.prototype.graph_selection=function(t){},c.prototype.vertex_click=function(t,e,i,o){o&&o.vertex&&o.vertex._parentElement.node().parentNode.appendChild(o.vertex._parentElement.node()),r.prototype.vertex_click.apply(this,arguments)},c.prototype.vertex_dblclick=function(t,e,i,r){},c.prototype.vertex_mouseover=function(t,e){this.highlightVertex(t,e)},c.prototype.vertex_mouseout=function(t,e){this.highlightVertex(null,null)},c.prototype.edge_mouseover=function(t,e){this.highlightEdge(t,e)},c.prototype.edge_mouseout=function(t,e){this.highlightEdge(null,null)},c.prototype.addMarkers=function(t){t&&(this.defs.select("#"+this._id+"_arrowHead").remove(),this.defs.select("#"+this._id+"_circleFoot").remove(),this.defs.select("#"+this._id+"_circleHead").remove(),this.defs.select("#"+this._id+"_glow").remove()),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_arrowHead").attr("viewBox","0 0 10 10").attr("refX",10).attr("refY",5).attr("markerWidth",8).attr("markerHeight",8).attr("markerUnits","strokeWidth").attr("orient","auto").append("polyline").attr("points","0,0 10,5 0,10 1,5"),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleFoot").attr("viewBox","0 0 10 10").attr("refX",1).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleHead").attr("viewBox","0 0 10 10").attr("refX",9).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4);var e=this.defs.append("filter").attr("id",this._id+"_glow").attr("width","130%").attr("height","130%");e.append("feOffset").attr("result","offOut").attr("in","SourceGraphic").attr("dx","0").attr("dy","0"),e.append("feColorMatrix").attr("result","matrixOut").attr("in","offOut").attr("type","matrix").attr("values","0.2 0 0 0 0 0 0.2 0 0 1 0 0 0.2 0 0 0 0 0 1 0"),e.append("feGaussianBlur").attr("result","blurOut").attr("in","matrixOut").attr("stdDeviation","3"),e.append("feBlend").attr("in","SourceGraphic").attr("in2","blurOut").attr("mode","normal")},c});