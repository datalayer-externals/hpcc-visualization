!function(e,t){"function"==typeof define&&define.amd?define(["d3","../common/CanvasWidget","../common/Palette","../api/IGraph","./VertexC","./EdgeC","./GraphData","./GraphLayouts","../common/Utility"],t):e.graph_Graph=t(e.d3,e.common_CanvasWidget,e.common_Palette,e.api_IGraph,e.graph_VertexC,e.graph_EdgeC,e.graph_GraphData,e.graph_GraphLayouts,e.common_Utility)}(this,function(e,t,o,r,i,a,n,s,h){function c(){t.call(this),r.call(this),this.graphData=new n,this.highlight={zoom:1.1,opacity:.33,edge:"1.25px"},this._selection=new h.Selection,this.log=[],this._translate={x:0,y:0},this._scale={k:1}}return c.prototype=Object.create(t.prototype),c.prototype.constructor=c,c.prototype._class+=" graph_GraphC",c.prototype["implements"](r.prototype),c.prototype.Vertex=i,c.prototype.Edge=a,c.prototype.publish("allowDragging",!0,"boolean","Allow Dragging of Vertices"),c.prototype.publish("layout","Circle","set","Default Layout",["Circle","ForceDirected","ForceDirected2","Hierarchy","None"]),c.prototype.publish("scale","100%","set","Zoom Level",["all","width","selection","100%","90%","75%","50%","25%","10%"]),c.prototype.publish("applyScaleOnLayout",!1,"boolean","Shrink to fit on Layout"),c.prototype.publish("highlightOnMouseOverVertex",!1,"boolean","Highlight Vertex on Mouse Over"),c.prototype.publish("highlightOnMouseOverEdge",!1,"boolean","Highlight Edge on Mouse Over"),c.prototype.publish("transitionDuration",250,"number","Transition Duration"),c.prototype.publish("showEdges",!0,"boolean","Show Edges"),c.prototype.publish("snapToGrid",0,"number","Snap to Grid"),c.prototype.publish("hierarchyRankDirection","TB","set","Direction for Rank Nodes",["TB","BT","LR","RL"]),c.prototype.publish("hierarchyNodeSeparation",50,"number","Number of pixels that separate nodes horizontally in the layout"),c.prototype.publish("hierarchyEdgeSeparation",10,"number","Number of pixels that separate edges horizontally in the layout"),c.prototype.publish("hierarchyRankSeparation",50,"number","Number of pixels between each rank in the layout"),c.prototype.publish("forceDirectedLinkDistance",300,"number","Target distance between linked nodes"),c.prototype.publish("forceDirectedLinkStrength",1,"number","Strength (rigidity) of links"),c.prototype.publish("forceDirectedFriction",.9,"number","Friction coefficient"),c.prototype.publish("forceDirectedCharge",-25,"number","Charge strength "),c.prototype.publish("forceDirectedChargeDistance",1e4,"number","Maximum distance over which charge forces are applied"),c.prototype.publish("forceDirectedTheta",.8,"number","Barnesâ€“Hut approximation criterion"),c.prototype.publish("forceDirectedGravity",.1,"number","Gravitational strength"),c.prototype.draw=function(){null!==this.element().node()&&(this.clearCanvas(),this.drawLinks(),this.drawNodes())},c.prototype.drawNodes=function(){var e=this;this.graphData.nodeValues().forEach(function(t){t.drawSelf(e.ctx,e.element().node())})},c.prototype.drawLinks=function(){var e=this;this.graphData.edgeValues().forEach(function(t){t.drawSelf(e.ctx,e.element().node())})},c.prototype.clearCanvas=function(e,t,o,r){var i=this;if("undefined"!=typeof e)i.ctx.clearRect(e,t,o,r);else{var a=i.element().node(),n=this.zoom.scale(),s=a.width/n,h=a.height/n;i.ctx.clearRect(10*-s,10*-h,10*s*2,10*h*2)}},c.prototype.getOffsetPos=function(){return{x:0,y:0}},c.prototype.size=function(e){var o=t.prototype.size.apply(this,arguments);return arguments.length&&this._svgZoom&&this._svgZoom.attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),o},c.prototype.clear=function(){this.data({vertices:[],edges:[],hierarchy:[],merge:!1})},c.prototype.data=function(e){var o=t.prototype.data.apply(this,arguments);if(arguments.length){this.data().merge||(this.graphData=new n,this._renderCount=0);var r=this.graphData.setData(this.data().vertices||[],this.data().edges||[],this.data().hierarchy||[],this.data().merge||!1),i=this;r.addedVertices.forEach(function(e){e._graphID=i._id,e.pos({x:10*+Math.random()/2-5,y:10*+Math.random()/2-5})}),r.addedEdges.forEach(function(e){e._graphID=i._id});var a={};this.graphData.edgeValues().forEach(function(e){a[e._sourceVertex._id]||(a[e._sourceVertex._id]={}),a[e._sourceVertex._id][e._targetVertex._id]||(a[e._sourceVertex._id][e._targetVertex._id]=0);var t=++a[e._sourceVertex._id][e._targetVertex._id];e.arcDepth(16*t)}),this.ctx&&this.ctx.setTransform(1,0,0,1,0,0),this.draw()}return o},c.prototype.selection=function(e){return arguments.length?(this._selection.set(e),this):this._selection.get()},c.prototype.setZoom=function(e,t,o){this.zoom&&(this.zoom.translate(e),this.zoom.scale(t),this.applyZoom(o))},c.prototype.applyZoom=function(t){var o=e.event&&("wheel"===e.event.sourceEvent.type||"mousewheel"===e.event.sourceEvent.type||"DOMMouseScroll"===e.event.sourceEvent.type);e.event&&e.event.sourceEvent&&e.event.sourceEvent.ctrlKey&&o&&e.event.sourceEvent.wheelDelta&&(this.zoom.translate([this.prevTranslate[0],this.prevTranslate[1]+e.event.sourceEvent.wheelDelta]),this.zoom.scale(this.prevScale));var r=this.zoom.translate();r[0]+=this._size.width/2,r[1]+=this._size.height/2,this._translate=r;var i=this.zoom.scale(),a=!this.prevTranslate||this.prevTranslate[0]!==r[0]||this.prevTranslate[1]!==r[1],n=this.prevScale!==this.zoom.scale();(a||n)&&(this.ctx.setTransform(1,0,0,1,r[0],r[1]),this.ctx.scale(i,i)),this.prevTranslate=this.zoom.translate(),this.prevScale!==this.zoom.scale()&&(this.prevScale=this.zoom.scale())},c.prototype.linkcolor_default=function(e){return arguments.length?(this._linkcolor=e,this):this._linkcolor},c.prototype.linktooltip_default=function(e){return arguments.length?(this._linktooltip=e,this):this._linktooltip},c.prototype.enter=function(o,r){t.prototype.enter.apply(this,arguments);var i=this;r.on("click",function(){var t=(e.event.layerX-i._translate[0])/i.zoom.scale(),o=(e.event.layerY-i._translate[1])/i.zoom.scale();i.data().vertices.forEach(function(e){var r=e.getHoveredPolygons(t,o);r.length>0&&i.vertex_click(i.rowToObj(e.data(),"",!0,{vertex:e}))})}),r.on("dblclick",function(){var t=(e.event.layerX-i._translate[0])/i.zoom.scale(),o=(e.event.layerY-i._translate[1])/i.zoom.scale();i.data().vertices.forEach(function(e){var r=e.getHoveredPolygons(t,o);r.length>0&&i.vertex_dblclick(i.rowToObj(e.data(),"",!0,{vertex:e}))})}),r.on("mousemove",function(){if("undefined"!=typeof i.data().vertices){var t=i.ctx;i.draw();var o=(e.event.layerX-i._translate[0])/i.zoom.scale(),r=(e.event.layerY-i._translate[1])/i.zoom.scale();i.data().vertices.forEach(function(e){var i=e.getHoveredPolygons(o,r);i.length>0&&i.forEach(function(e){e[4].vertex.drawPolyTooltip(e,t)})})}}),this.prevTranslate=[0,0],this.prevScale=1,this.zoom=e.behavior.zoom().scaleExtent([.01,4]).on("zoomstart",function(t){if(!i.draggedVertex)switch(i.prevTranslate=i.zoom.translate(),i.prevScale=i.zoom.scale(),e.event.sourceEvent&&e.event.sourceEvent.shiftKey&&e.event.sourceEvent.ctrlKey?i._zoomMode="selection":e.event.sourceEvent&&e.event.sourceEvent.shiftKey?(i._zoomMode="selection",i._selection.clear()):i._zoomMode="zoom",i._zoomMode){case"selection":r.select(".extent").style("visibility",null);break;default:r.select(".extent").style("visibility","hidden")}}).on("zoomend",function(e){if(!i.draggedVertex)switch(i._zoomMode){case"selection":i.zoom.translate(i.prevTranslate),i.zoom.scale(i.prevScale)}}).on("zoom",function(e){if(!i.draggedVertex){switch(i._zoomMode){case"selection":break;default:i.applyZoom()}i.draw()}}),this.drag=e.behavior.drag().on("dragstart",function(t){if("undefined"!=typeof i.data().vertices){var o=(e.event.sourceEvent.layerX-i._translate[0])/i.zoom.scale(),r=(e.event.sourceEvent.layerY-i._translate[1])/i.zoom.scale();i.data().vertices.forEach(function(e){var t=e.getHoveredPolygons(o,r);t.length>0&&t.forEach(function(e){i.draggedVertex=e[4].vertex})})}}).on("drag",function(t){if(i.draggedVertex){var o=(e.event.sourceEvent.layerX-i._translate[0])/i.zoom.scale(),r=(e.event.sourceEvent.layerY-i._translate[1])/i.zoom.scale();i.draggedVertex.x(o),i.draggedVertex.y(r)}}).on("dragend",function(e){i.draggedVertex&&delete i.draggedVertex}),r.attr("width",this._size.width).attr("height",this._size.height),this.ctx=o.getContext("2d"),r.call(this.zoom),r.call(this.drag),this.draw(),setTimeout(function(){i.draw()},1e3)},c.prototype.getBounds=function(e,t){var o=[[null,null],[null,null]];return e.forEach(function(e){var r=t?t.nodePos(e._id):{x:e.x(),y:e.y(),width:e.width(),height:e.height()};if(r){var i=r.x-r.width/2,a=r.x+r.width/2,n=r.y-r.height/2,s=r.y+r.height/2;(null===o[0][0]||o[0][0]>i)&&(o[0][0]=i),(null===o[0][1]||o[0][1]>n)&&(o[0][1]=n),(null===o[1][0]||o[1][0]<a)&&(o[1][0]=a),(null===o[1][1]||o[1][1]<s)&&(o[1][1]=s)}}),o},c.prototype.getVertexBounds=function(e){return this.getBounds(this.graphData.nodeValues(),e)},c.prototype.getSelectionBounds=function(e){return this.getBounds(this._selection.get(),e)},c.prototype.shrinkToFit=function(e,t){var o=this.width(),r=this.height(),i=e[1][0]-e[0][0],a=e[1][1]-e[0][1],n=(e[0][0]+e[1][0])/2,s=(e[0][1]+e[1][1])/2,h=1/Math.max(i/o,a/r);h>1&&(h=1);var c=[-h*n,-h*s];this.setZoom(c,h,t)},c.prototype._origScale=c.prototype.scale,c.prototype.scale=function(e,t){var o=c.prototype._origScale.apply(this,arguments);return arguments.length&&this.zoomTo(e,t),o},c.prototype.zoomTo=function(e,t){switch(e){case"all":this.shrinkToFit(this.getVertexBounds(),t);break;case"width":var o=this.getVertexBounds();o[0][1]=0,o[1][1]=0,this.shrinkToFit(o,t);break;case"selection":this.shrinkToFit(this._selection.isEmpty()?this.getVertexBounds():this.getSelectionBounds(),t);break;default:var r=parseInt(e);(isNaN(r)||0>=r||r>200)&&(r=100),this.zoom.scale(r/100),this.applyZoom(t)}this.draw()},c.prototype.centerOn=function(e,t){var o=(e[0][0]+e[1][0])/2,r=(e[0][1]+e[1][1])/2,i=[o,r];this.setZoom(i,1,t)},c.prototype._origLayout=c.prototype.layout,c.prototype.layout=function(e,t){var o=c.prototype._origLayout.apply(this,arguments);if(arguments.length){if(this._renderCount){this.forceLayout&&(this.forceLayout.force.stop(),this.forceLayout=null);var r=this,i=this.getLayoutEngine();if("ForceDirected2"===this.layout())this.forceLayout=i,this.forceLayout.force.on("tick",function(e){if(i.vertices.forEach(function(e){if(e.fixed)e.x=e.px,e.y=e.py;else{e.px=e.x,e.py=e.y;var t=r.graphData.node(e.id);t&&(t.x(e.x),t.y(e.y))}}),r.graphData.edgeValues().forEach(function(e){e.points([],!1,!1)}),r.applyScaleOnLayout()){var t=r.getVertexBounds(i);r.shrinkToFit(t)}r.draw()}),this.forceLayout.force.start();else if(i){if(this.forceLayout=null,r._dragging=!0,r.graphData.nodeValues().forEach(function(e){var t=i.nodePos(e._id);e.x(t.x),e.y(t.y)}),r.graphData.edgeValues().forEach(function(e){var o=i.edgePoints(e);e.points(o,t)}),r.applyScaleOnLayout()){var a=r.getVertexBounds(i);r.shrinkToFit(a,t)}setTimeout(function(){r._dragging=!1},t?t+50:50)}}this.zoomTo("all")}return o},c.prototype.update=function(e,o){t.prototype.update.apply(this,arguments),this._renderCount||(this._renderCount++,this.setZoom([.1,0],1),this.layout(this.layout())),this.clearCanvas(),this.drawLinks(),this.drawNodes()},c.prototype.getLayoutEngine=function(){switch(this.layout()){case"Circle":return new s.Circle(this.graphData,this._size.width,this._size.height);case"ForceDirected":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{oneShot:!0,linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"ForceDirected2":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"Hierarchy":return new s.Hierarchy(this.graphData,this._size.width,this._size.height,{rankdir:this.hierarchyRankDirection(),nodesep:this.hierarchyNodeSeparation(),edgesep:this.hierarchyEdgeSeparation(),ranksep:this.hierarchyRankSeparation()})}return null},c.prototype.resize=function(e){var o=t.prototype.resize.apply(this,arguments);return this.zoomTo("all"),o},c.prototype.graph_selection=function(e){},c.prototype.vertex_click=function(e,t,o,i){i&&i.vertex&&i.vertex._parentElement.node().parentNode.appendChild(i.vertex._parentElement.node()),r.prototype.vertex_click.apply(this,arguments)},c.prototype.vertex_dblclick=function(e,t,o,r){},c.prototype.vertex_mouseover=function(e,t){this.highlightVertex(e,t)},c.prototype.vertex_mouseout=function(e,t){this.highlightVertex(null,null)},c.prototype.edge_mouseover=function(e,t){this.highlightEdge(e,t)},c.prototype.edge_mouseout=function(e,t){this.highlightEdge(null,null)},c});