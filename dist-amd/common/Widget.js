!function(t,e){"function"==typeof define&&define.amd?define(["d3","./Class","./Platform","./PropertyExt","./Database"],e):t.common_Widget=e(t.d3,t.common_Class,t.common_Platform,t.common_PropertyExt,t.common_Database)}(this,function(t,e,i,s,n){function o(){e.call(this),i.call(this),s.call(this),this._class=Object.getPrototypeOf(this)._class,this._id=this._idSeed+r++,this._db=new n.Grid,this._pos={x:0,y:0},this._size={width:0,height:0},this._scale=1,this._visible=!0,this._target=null,this._parentElement=null,this._parentWidget=null,this._element=t.select(),this._renderCount=0,window.__hpcc_debug&&(void 0===window.g_all&&(window.g_all={}),window.g_all[this._id]=this),window.__hpcc_theme&&this.applyTheme(window.__hpcc_theme)}var r=0;return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.mixin(i),o.prototype.mixin(s),o.prototype._class+=" common_Widget",o.prototype._idSeed="_w",o.prototype.publishProxy("fields","_db","fields"),o.prototype.publish("classed",{},"object","HTML Classes",null,{tags:["Private"]}),o.prototype["export"]=function(t){switch(t){case"TSV":return this._db.tsv();case"JSON":return this._db.json()}return this._db.csv()},o.prototype.leakCheck=function(t){for(var e=this,i=[t],s=new this.MutationObserver(function(t){var n=!1;t.forEach(function(t){for(var o=0;o<t.removedNodes.length;++o){var r=t.removedNodes.item(o);i.indexOf(r)>=0&&e._target&&(n=!0,s.disconnect())}}),n&&console.log("leak:  "+e.id()+" - "+e.classID()+"		widget.target(null); was not called for this widget before it was removed from the page.")}),n=t.parentNode;n;)s.observe(n,{childList:!0}),i.push(n),n=n.parentNode},o.prototype.on=function(e,i,s){var n=this;return this.overrideMethod(e,function(e,o){var r;return s?t.event&&t.event.stopPropagation():r=e.apply(n,o),i.apply(n,o)||r}),this},o.prototype.id=function(t){return arguments.length?(this._id=t,this):this._id},o.prototype.columns=function(t,e){return arguments.length?(this._db.legacyColumns(t,e),this):this._db.legacyColumns()},o.prototype.parsedData=function(){return this._db.parsedData()},o.prototype.formattedData=function(){return this._db.formattedData()},o.prototype.data=function(t){return arguments.length?(this._db.legacyData(t),this):this._db.legacyData()},o.prototype.cloneData=function(){return this.data().map(function(t){return t.slice(0)})},o.prototype.flattenData=function(){var t=[];return this.data().forEach(function(e,i){this.columns().filter(function(t,e){return e>0}).forEach(function(s,n){var o=e[n+1];if(o){var r={rowIdx:i,colIdx:n+1,label:e[0],value:o};t.push(r)}},this)},this),t},o.prototype.rowToObj=function(t){var e={};return this.fields().forEach(function(i,s){e[i.label_default()||i.label()]=t[s]}),t.length===this.columns().length+1&&(e.__lparam=t[this.columns().length]),e},o.prototype.pos=function(t){return arguments.length?(this._pos=t,this._overlayElement&&this._overlayElement.attr("transform","translate("+t.x+","+t.y+")scale("+this._scale+")"),this):this._pos},o.prototype.x=function(t){return arguments.length?(this.pos({x:t,y:this._pos.y}),this):this._pos.x},o.prototype.y=function(t){return arguments.length?(this.pos({x:this._pos.x,y:t}),this):this._pos.y},o.prototype.size=function(t){return arguments.length?(this._size=t,this._overlayElement&&this._overlayElement.attr("width",t.width).attr("height",t.height),this):this._size},o.prototype.width=function(t){return arguments.length?(this.size({width:t,height:this._size.height}),this):this._size.width},o.prototype.height=function(t){return arguments.length?(this.size({width:this._size.width,height:t}),this):this._size.height},o.prototype.resize=function(t,e){e=e||{width:0,height:0};var i,s;if(t&&t.width&&t.height)i=t.width,s=t.height;else{var n=window.getComputedStyle(this._target,null);i=parseFloat(n.getPropertyValue("width"))-e.width,s=parseFloat(n.getPropertyValue("height"))-e.height}return this.size({width:i,height:s}),this},o.prototype.scale=function(t){return arguments.length?(this._scale=t,this._overlayElement&&this._overlayElement.attr("transform","translate("+t.x+","+t.y+")scale("+this._scale+")"),this):this._scale},o.prototype.visible=function(t){return arguments.length?(this._visible=t,this._parentElement&&this._parentElement.style({visibility:this._visible?null:"hidden",opacity:this._visible?null:0}),this):this._visible},o.prototype.display=function(t){return arguments.length?(this._display=t,this._element&&this._element.style("display",this._display?null:"none"),this):this._display},o.prototype.calcSnap=function(t){function e(t,e){function i(t,e){var i=t%e;return Math.abs(i)>e-Math.abs(i)&&(i=(e-Math.abs(i))*(0>i?1:-1)),i}return t-i(t,e)}var i=e(this._pos.x-this._size.width/2,t),s=e(this._pos.y-this._size.height/2,t),n=e(this._pos.x+this._size.width/2,t),o=e(this._pos.y+this._size.height/2,t),r=n-i,h=o-s;return[{x:i+r/2,y:s+h/2},{width:r,height:h}]},o.prototype.toWidget=function(e){if(!e)return null;var i=t.select(e);if(i){var s=i.datum();if(s&&s instanceof o)return s}return null},o.prototype.locateParentWidget=function(t){if(t=t||(this._target?this._target.parentNode:null)){var e=this.toWidget(t);if(e)return e;if(t.parentNode)return this.locateParentWidget(t.parentNode)}return null},o.prototype.locateSVGNode=function(t){return t?"svg"===t.tagName?t:this.locateSVGNode(t.parentNode):null},o.prototype.locateOverlayNode=function(){for(var t=this.locateParentWidget(this._target);t;){if(t._parentOverlay)return t._parentOverlay;t=this.locateParentWidget(t._target.parentNode)}return null},o.prototype.locateAncestor=function(t){for(var e=this.locateParentWidget(this._target);e;){if(e.classID()===t)return e;e=this.locateParentWidget(e._target.parentNode)}return null},o.prototype.getAbsolutePos=function(t,e,i){var s=this.locateSVGNode(t);if(!s)return null;var n=s.createSVGPoint(),o=t.getCTM();n=n.matrixTransform(o);var r={x:n.x,y:n.y};if(void 0!==e&&void 0!==i){var h=s.createSVGPoint();h.x=e,h.y=i,h=h.matrixTransform(o),r.width=h.x-n.x,r.height=h.y-n.y}return r},o.prototype.hasOverlay=function(){return this._overlayElement},o.prototype.syncOverlay=function(){if(this._size.width&&this._size.height){var t=this.getAbsolutePos(this._overlayElement.node(),this._size.width,this._size.height);if(t&&(null===this.oldPos||void 0===this.oldPos||t.x!==this.oldPos.x||t.y!==this.oldPos.y||t.width!==this.oldPos.width||t.height!==this.oldPos.height)){var e=t.width/this._size.width,i=t.height/this._size.height;this._parentElement.style({left:t.x-t.width/e/2+"px",top:t.y-t.height/i/2+"px",width:t.width/e+"px",height:t.height/i+"px"});var s="scale("+e+","+i+")";this._parentElement.style("transform",s).style("-moz-transform",s).style("-ms-transform",s).style("-webkit-transform",s).style("-o-transform",s)}this.oldPos=t}},o.prototype.element=function(){return this._element},o.prototype.node=function(){return this._element.node()},o.prototype.render=function(e){if(window.__hpcc_debug){var i=Date.now();i-this._prevNow<500&&console.log("Double Render:  "+(i-this._prevNow)+" - "+this.id()+" - "+this.classID()),this._prevNow=i}if(e=e||function(){},!this._parentElement||!this.visible())return e(this),this;if(this._parentElement){if(!this._tag)throw"No DOM tag specified";var s=this._parentElement.selectAll("#"+this._id).data([this],function(t){return t._id});s.enter().append(this._tag).classed(this._class,!0).attr("id",this._id).each(function(e){e._element=t.select(this),e.enter(this,e._element),window.__hpcc_debug&&e.leakCheck(this)}),s.classed(this.classed()).each(function(t){t.preUpdate(this,t._element),t.update(this,t._element),t.postUpdate(this,t._element)}),s.exit().each(function(e){t.select(this).datum(null),e.exit(this,e._element)}).remove(),this._renderCount++}var n=[];this.publishedProperties(!0).forEach(function(t){if(!t.ext||t.ext.render!==!1)switch(t.type){case"widget":var e=this[t.id]();e&&n.push(this[t.id]());break;case"widgetArray":n=n.concat(this[t.id]())}},this);var o=this;switch(n.length){case 0:e(this);break;case 1:n[0].render(function(){e(o)});break;default:var r=n.length;n.forEach(function(t,i){setTimeout(function(){t.render(function(){0===--r&&e(o)})},0)})}return this},o.prototype.lazyRender=o.prototype.debounce(function(){this.render()},100),o.prototype.enter=function(t,e){},o.prototype.preUpdate=function(t,e){},o.prototype.update=function(t,e){},o.prototype.postUpdate=function(t,e){},o.prototype.exit=function(t,e){},o});