!function(t,e){"function"==typeof define&&define.amd?define(["d3","../common/SVGWidget","../common/Utility","css!./Axis"],e):t.chart_Axis=e(t.d3,t.common_SVGWidget,t.common_Utility)}(this,function(t,e,i){function s(){e.call(this),this._drawStartPos="origin",this.d3Axis=t.svg.axis(),this.d3Guides=t.svg.axis(),this.updateScale()}s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype._class+=" chart_Axis",s.prototype.publish("title","","string","Title"),s.prototype.publish("orientation","bottom","set","Orientation",["left","top","right","bottom"]),s.prototype.publish("type","linear","set","Type",["none","ordinal","linear","pow","log","time"]),s.prototype.publish("timePattern","%Y-%m-%d","string","Time Series Pattern",null,{disable:function(t){return"time"!==t.type()}}),s.prototype.publish("powExponent",2,"number","Exponent for Pow on Value Axis",null,{disable:function(t){return"pow"!==t.type()}}),s.prototype.publish("logBase",10,"number","Base for log on Value Axis",null,{disable:function(t){return"log"!==t.type()}}),s.prototype.publish("ordinals",[],"array","Ordinal Values",null,{disable:function(t){return"ordinal"!==t.type()}}),s.prototype.publish("tickCount",null,"number","Tick Count",null,{optional:!0,disable:function(t){return"ordinal"===t.type()}}),s.prototype.publish("tickFormat",null,"string","Tick Format",null,{optional:!0,disable:function(t){return"ordinal"===t.type()}}),s.prototype.publish("tickLength",null,"number","Tick Length",{optional:!0}),s.prototype.publish("low",null,"any","Low",null,{optional:!0,disable:function(t){return"ordinal"===t.type()}}),s.prototype.publish("high",null,"any","High",null,{optional:!0,disable:function(t){return"ordinal"===t.type()}}),s.prototype.publish("overlapMode","none","set","Label Overlap Mode",["none","stagger","hide","rotate","linebreak","wrap"]),s.prototype.publish("labelRotation",33,"number","Label Rotation",null,{optional:!0,disable:function(t){return"rotate"!==t.overlapMode()}}),s.prototype.publish("shrinkToFit","both","set","Size to fit",["none","low","high","both"]),s.prototype.publish("extend",5,"number","Extend axis %",{optional:!0,disable:function(t){return"ordinal"===t.type()}});var a=s.prototype.type;s.prototype.type=function(t){var e=a.apply(this,arguments);return arguments.length&&this.updateScale(),e};var r=s.prototype.timePattern;return s.prototype.timePattern=function(t){var e=r.apply(this,arguments);return arguments.length&&this.updateScale(),e},s.prototype.lowValue=function(){return this.parse(this.low())},s.prototype.highValue=function(){return this.parse(this.high())},s.prototype.parse=function(t,e){if(t instanceof Array)return t.map(function(t){return this.parse(t)},this);if(void 0!==t&&null!==t){if(this.parser)return this.parser.parse("number"==typeof t?t.toString():t);if(e&&"string"==typeof t)return+t}return t},s.prototype.parseInvert=function(t){return t instanceof Array?t.map(function(t){return this.parseInvert(t)},this):this.parser&&t?this.parser(t):t},s.prototype.format=function(t){return t instanceof Array?t.map(function(t){return this.format(t)},this):void 0!==t&&null!==t&&this.formatter?this.formatter(t):t},s.prototype.scalePos=function(t){var e=this.d3Scale(this.parse(t));return"ordinal"===this.type()&&(e+=this.d3Scale.rangeBand()/2),e},s.prototype.isHorizontal=function(){switch(this.orientation()){case"left":case"right":return!1}return!0},s.prototype.domain=function(t){return arguments.length?(this.d3Scale.domain(t),this):this.d3Scale.domain()},s.prototype.range=function(t){if(!arguments.length){if(this.d3Scale.rangeRoundBands)return this.d3Scale.rangeExtent();if(this.d3Scale.rangeRound)return this.d3Scale.range()}return this.d3Scale.rangeRoundBands?this.d3Scale.rangeRoundBands(t,.1):this.d3Scale.rangeRound&&this.d3Scale.range(t),this},s.prototype.invert=function(t){return this.d3Scale.invert(t)},s.prototype.guideTarget=function(e){this._guideElement=t.select(e).attr("class",this._class)},s.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this.svg=i.append("g"),this.svgAxis=this.svg.append("g").attr("class","axis"),this.svgText=this.svgAxis.append("text"),this.svg2=(this._guideElement||i).append("g"),this.svgGuides=this.svg2.attr("class","guide")},s.prototype.updateScale=function(){switch(this.type()){case"ordinal":this.d3Scale=t.scale.ordinal(),this.ordinals_exists()&&this.d3Scale.domain(this.ordinals()),this.parser=null,this.formatter=null;break;case"linear":this.d3Scale=t.scale.linear(),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?t.format(this.tickFormat()):null;break;case"pow":this.d3Scale=t.scale.pow().exponent(this.powExponent()),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?t.format(this.tickFormat()):null;break;case"log":this.d3Scale=t.scale.log().base(this.logBase()),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?t.format(this.tickFormat()):null;break;case"time":this.d3Scale=t.time.scale(),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=this.timePattern_exists()?t.time.format(this.timePattern()):null,this.formatter=this.tickFormat_exists()?t.time.format(this.tickFormat()):null}if(this.extend())switch(this.type()){case"ordinal":break;default:var e,i,s,a,r,n;this.isHorizontal()?(e=this.width(),this.d3Scale.range([0,e]),i=e*this.extend()/100,s=this.d3Scale.invert(0),r=this.d3Scale.invert(-i),a=this.d3Scale.invert(e),n=this.d3Scale.invert(e+i)):(e=this.height(),this.d3Scale.range([e,0]),i=e*this.extend()/100,s=this.d3Scale.invert(e),r=this.d3Scale.invert(e+i),a=this.d3Scale.invert(0),n=this.d3Scale.invert(-i)),Math.sign(s)!==Math.sign(r)&&(r=0),Math.sign(a)!==Math.sign(n)&&(n=0),this.d3Scale.domain([r,n])}this.d3Axis.orient(this.orientation()).scale(this.d3Scale).tickFormat(this.formatter).ticks(this.tickCount()),this.d3Guides.orient(this.orientation()).scale(this.d3Scale).tickSize(-this.tickLength()).tickFormat("").ticks(this.tickCount())},s.prototype.adjustText=function(e,i){var s=this.isHorizontal(),a="left"===this.orientation(),r="bottom"===this.orientation(),n=this;if("linebreak"===this.overlapMode())"ordinal"===this.type()&&e.selectAll(".tick > text").call(function(){return n.linebreak.apply(n,arguments)},this.d3Scale.rangeBand());else if("wrap"===this.overlapMode())"ordinal"===this.type()&&e.selectAll(".tick > text").call(function(){return n.wrap.apply(n,arguments)},this.d3Scale.rangeBand());else switch(s?this.overlapMode():"none"){case"stagger":e.selectAll(".tick > text").style("text-anchor","middle").attr("dy",function(t,e){return(r?1:-1)*((r?.71:0)+e%i)+"em"}).attr("dx",0).attr("visibility",null).attr("transform","rotate(0)");break;case"hide":e.selectAll(".tick > text").style("text-anchor","middle").attr("dy",(r?.71:0)+"em").attr("dx",0).attr("visibility",function(t,e){return e%i?"hidden":null}).attr("transform","rotate(0)");break;case"rotate":var o=-this.labelRotation()||0;if(0!==o&&i>1){e.selectAll(".tick > text").each(function(){var e=t.select(this),i=e.node().getBBox(),s=(r?1:-1)*Math.sin(Math.PI*(-Math.abs(o)/180));e.style("text-anchor",o>0?r?"start":"end":r?"end":"start").attr("dy",i.height/2*s+"px").attr("dx",o>0?r?"0.71em":"-0.71em":r?"-0.71em":"0.71em").attr("transform","rotate("+o+")").attr("visibility",null)});break}default:e.selectAll(".tick > text").style("text-anchor",s?"middle":a?"end":"start").attr("dy",s?(r?.71:0)+"em":"0.32em").attr("dx",0).attr("visibility",null).attr("transform","rotate(0)")}},s.prototype.calcTickOverlapModulus=function(t){var e=1;switch(this.overlapMode()){case"rotate":case"stagger":case"hide":var i=[];t.selectAll(".tick > text").each(function(t){for(var s=this.getBoundingClientRect(),a=i.length-1;a>=0&&!(i[a].right<s.left);--a)i.length+1-a>e&&(e=i.length+1-a);i.push(s)})}return e},s.prototype.calcOverflow=function(t,e){this.updateScale();var i=this.isHorizontal();this.range(i?[0,this.width()]:[this.height(),0]);var s=t.append("g").attr("class",this.classID()).append("g");s.attr("class",i?"x":"y").call(this.d3Axis),e&&t.selectAll(".tick > text").remove();var a={left:0,top:0,right:0,bottom:0,tickOverlapModulus:this.calcTickOverlapModulus(s)};this.adjustText(s,a.tickOverlapModulus);var r=s.node().getBBox();switch(a.depth=i?r.height:r.width,this.shrinkToFit()){case"low":case"both":a.left=i?-r.x:0,a.bottom=i?0:-(this.height()-(r.height+r.y))}switch(this.shrinkToFit()){case"high":case"both":a.top=i?0:-r.y,a.right=i?-(this.width()-r.x-r.width):0}return s.remove(),a},s.prototype.wrap=function(e,i,s){s=s||/\s+/;var a=this;e.each(function(){for(var e,r=t.select(this),n=r.text().split(s).reverse(),o=[],l=0,h=1.1,p=r.attr("x"),c=r.attr("y"),u=parseFloat(r.style("font-size"))||10,d=Math.floor(i/(u*h))-1,g=a.isHorizontal()?1:Math.ceil(n.length/d),m=parseFloat(r.attr("dy")),y=r.text(null).append("tspan").attr("x",p).attr("y",c).attr("dy",m+"em"),f=0;e=n.pop();)o.push(e),y.text(o.join(" ")),f++,y.node().getComputedTextLength()>i&&f>=g&&(o.pop(),y.text(o.join(" ")),o=[e],y=r.append("tspan").attr("x",p).attr("y",c).attr("dy",++l*h+m+"em").text(e),f=0);a.isHorizontal()||r.selectAll("tspan").attr("y",-l/2+"em")})},s.prototype.linebreak=function(t,e){this.wrap(t,e,"\n")},s.prototype.update=function(t,i){function s(t){t.attr("transform",function(t){switch(r.orientation()){case"left":return"translate("+a.depth+", "+a.top+")";case"top":return"translate(0,"+a.depth+")";case"right":return"translate("+(r.width()-a.depth)+", "+a.top+")";case"bottom":return"translate(0,"+(r.height()-a.depth)+")"}return"translate(0,0)"})}e.prototype.update.apply(this,arguments);var a=this.calcOverflow(i);this.range(this.isHorizontal()?[a.left,this.width()-a.right]:[this.height()-a.top-a.bottom,0]);var r=this;this.svg.style("visibility","none"===this.type()?"hidden":null).transition().call(s),this._guideElement&&this.svg2.transition().call(s),this.svgAxis.call(this.d3Axis),this.adjustText(this.svgAxis,a.tickOverlapModulus);var n=this.svgAxis.select("path.domain"),o=n.node().getBBox();switch(this.orientation()){case"left":this.svgText.transition().attr("transform","rotate(-90)").attr("x",-2).attr("y",2).attr("dx",null).attr("dy",".71em").style("text-anchor","end").text(this.title());break;case"right":this.svgText.transition().attr("transform","rotate(-90)").attr("x",-2).attr("y",4).attr("dx",null).attr("dy","-.71em").style("text-anchor","end").text(this.title());break;case"top":this.svgText.transition().attr("transform","rotate(0)").attr("x",o.x+o.width-2).attr("y",2).attr("dx",null).attr("dy",".71em").style("text-anchor","end").text(this.title());break;case"bottom":this.svgText.transition().attr("transform","rotate(0)").attr("x",o.x+o.width-2).attr("y",-2).attr("dx",null).attr("dy",null).style("text-anchor","end").text(this.title())}this.svgGuides.call(this.d3Guides)},s.prototype.postUpdate=function(t,i){e.prototype.postUpdate.apply(this,arguments),this._guideElement&&this._guideElement.attr("transform",this._element.attr("transform"))},s});