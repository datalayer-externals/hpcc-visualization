!function(t,i){"function"==typeof define&&define.amd?define(["d3","../common/Class","../common/PropertyExt","../common/Utility","./HipieDDL","../other/Persist","../layout/Modal","../layout/Surface","./FlyoutButton"],i):t.marshaller_HipieDDLMixin=i(t.d3,t.common_Class,t.common_PropertyExt,t.common_PropertyExt,t.common_Utility,t.other_Persist,t.layout_Modal,t.layout_Surface,t.marshaller_FlyoutButton)}(this,function(t,i,a,e,s,o,l,r,n){function d(){i.call(this),a.call(this)}d.prototype=Object.create(i.prototype),d.prototype.constructor=d,d.prototype.mixin(a),d.prototype._class+=" marshaller_HipieDDLMixin",d.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),d.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),d.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),d.prototype.publish("timeout",null,"number","Timout (seconds)",null,{optional:!0}),d.prototype.publish("clearDataOnUpdate",!0,"boolean","Clear data prior to refresh",null),d.prototype.publish("propogateClear",!1,"boolean","Propogate clear to dependent visualizations",null),d.prototype.publish("missingDataString","***MISSING***","string","Missing data display string"),d.prototype.publish("autoCloseFlyout",!0,"boolean","Auto Close Flyout Filters"),d.prototype.publish("disableModals",!1,"boolean","If true, widgets with 'modalIfData' will display as standard Grid widgets"),d.prototype._gatherDashboards=function(t,i){i instanceof Object||i&&(i=JSON.parse(i)),this._ddlDashboards=[],this._ddlVisualizations=[],this._ddlDisableModalVisualizations=[],this._ddlPopupVisualizations=[],this._ddlLayerVisualizations=[],this._ddlModalVisualizations=[];var a=this,e=null;t.accept({visit:function(t){t instanceof s.Dashboard?(e={dashboard:t,visualizations:[],disableModalVisualizations:[],popupVisualizations:[],layerVisualizations:[],modalVisualizations:[]},a._ddlDashboards.push(e)):t instanceof s.Datasource?t.databomb&&i[t.id]&&t.comms.databomb(i[t.id]):t instanceof s.Output?t.datasource.databomb&&t.datasource.comms.databombOutput(t.from,t.id):t instanceof s.Visualization&&t.widget&&(t.properties.flyout?a.disableModals()?(e.disableModalVisualizations.push(t),a._ddlDisableModalVisualizations.push(t)):(e.popupVisualizations.push(t),a._ddlPopupVisualizations.push(t)):t.parentVisualization?(e.layerVisualizations.push(t),a._ddlLayerVisualizations.push(t)):t.properties.modalIfData?a.disableModals()?(e.disableModalVisualizations.push(t),a._ddlDisableModalVisualizations.push(t)):(e.modalVisualizations.push(t),a._ddlModalVisualizations.push(t)):(e.visualizations.push(t),a._ddlVisualizations.push(t)))}}),this._ddlVisualizations=this._ddlVisualizations.concat(this._ddlDisableModalVisualizations),delete this._ddlDisableModalVisualizations,this._ddlDashboards.forEach(function(t){t.visualizations=t.visualizations.concat(t.disableModalVisualizations),delete t.disableModalVisualizations})},d.prototype._marshallerRender=function(i,a){function e(){u._gatherDashboards(u._marshaller,u.databomb()),u._ddlVisualizations.forEach(function(t){h.remove(t.id),u._marshaller.widgetMappings().get(t.id)||(t.newWidgetSurface=null,t.widget instanceof r||"composite_MegaChart"===t.widget.classID()?t.newWidgetSurface=t.widget:t.newWidgetSurface=(new r).widget(t.widget),t.newWidgetSurface.title(t.title),t.widget.size({width:0,height:0}))}),u._ddlPopupVisualizations.forEach(function(t){h.remove(t.id),t.widget.classed({flyout:!0});var i=t.events.getUpdatesVisualizations();i.forEach(function(i){switch(i.widget.classID()){case"composite_MegaChart":t._flyoutButton?i.widget.toolbarWidgets().push(t._flyoutButton.reference()):(t._flyoutButton=(new n).classed({"composite_MegaChart-flyout":!0}).title(t.title).widget(t.widget).autoClose(u.autoCloseFlyout()),i.widget.toolbarWidgets().push(t._flyoutButton))}})}),u._ddlModalVisualizations.forEach(function(i){i.widget.showCSV?i.widget.showToolbar(!0):i.widget.showToolbar&&i.widget.showToolbar(!1),i._modalTarget=t.select("body").append("div").node(),i._modal=(new l).target(i._modalTarget).bodyPadding("0px").overflowX("hidden").overflowY("hidden"),i._modal._widget=i.widget;var a=i.widget.render;i.widget.render=function(t){if(this.__inModal)return a.apply(this,arguments);if(this.data().length){this.__inModal=!0;var e=this,s=i.widget.title();i.widget.showToolbar()&&i.widget.titleFontColor("transparent"),i._modal.title(s).visible(!0).fixedWidth("80%").fixedHeight("80%").render(function(i){t&&t(e),setTimeout(function(){e.__inModal=!1},300)})}else t&&t(this);return this}}),h.forEach(function(t,i){u.clearContent(i)}),u.populateContent(),u._initialState?(u._marshaller.deserializeState(u._initialState.marshaller),delete u._initialState,i.render.call(u,a)):i.render.call(u,function(t){u._marshaller.primeData().then(function(i){a&&a(t)})})}if(""===this.ddlUrl()||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb&&this.disableModals()===this._prevDisableModals)return this._marshaller&&this._marshaller.proxyMappings(this.proxyMappings()).timeout(this.timeout()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()),i.render.call(this,function(t){a&&a(t)});this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearContent(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb(),this._prevDisableModals=this.disableModals();var d=[];o.widgetArrayWalker(this.content(),function(t){d.push(t)});var p=t.map(d,function(t){return t.id()}),h=t.map(d.filter(function(t){return 0!==t.id().indexOf(t._idSeed)&&0!==t.id().indexOf("_pe")}),function(t){return t.id()}),u=this;this._marshaller=(new s.Marshaller).proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()).widgetMappings(p).on("commsEvent",function(t,i){u.commsEvent.apply(u,arguments)}).on("vizEvent",function(){u.vizEvent.apply(u,arguments)}),"["===this.ddlUrl()[0]||"{"===this.ddlUrl()[0]?this._marshaller.parse(this.ddlUrl(),e):this._marshaller.url(this.ddlUrl(),e)},d.prototype.primeData=function(t){return this._marshaller?this._marshaller.primeData(t):Promise.resolve()},d.prototype.dashboards=function(){var t={};for(var i in this._marshaller.dashboards)t[i]={},this._marshaller.dashboards[i].visualizations.forEach(function(a){t[i][a.id]=a.widget},this);return t},d.prototype.visualizations=function(){return this._marshaller._visualizationArray.map(function(t){return t.newWidgetSurface||t.widget})};var p="<!doctype html><html><head><meta charset='utf-8'><script src='http://viz.hpccsystems.com/v1.14.0-rc5/dist-amd/hpcc-viz.js'></script><script src='http://viz.hpccsystems.com/v1.14.0-rc5/dist-amd/hpcc-viz-common.js'></script></head><body style='padding:0px; margin:0px; overflow:hidden'><div id='placeholder' style='width:100%; height:100vh'></div><script>   require(['src/other/Persist'], function (Persist) {\n       Persist.create({STATE}, function(widget) {\n           widget\n               .target('placeholder')\n               .ddlUrl('{DDL}')\n               .databomb('{DATABOMB}')\n               .render()\n           ;\n       });\n   });</script></body></html>";return d.prototype.generateTestPage=function(){if(this._marshaller){var t=this,i=o.serialize(t,function(t,i){return"databomb"===i.id||"ddlUrl"===i.id?!0:!1}),a=this._marshaller.createDatabomb(),s=p.replace("{VERSION}",t.version()).replace("{STATE}",i).replace("{DDL}",t._marshaller._json.replace("WUID","databomb")).replace("{DATABOMB}",JSON.stringify(a));e.downloadBlob("html",s,"test")}},d.prototype.vizEvent=function(t,i,a,e,s){},d.prototype.commsEvent=function(t,i,a,e){},d.prototype.state=function(t){return arguments.length?(this.deserializeState(t),this):this.serializeState()},d.prototype.serializeState=function(){return{marshaller:this._marshaller?this._marshaller.serializeState():{}}},d.prototype.deserializeState=function(t){return this._marshaller?this._marshaller.deserializeState(t.marshaller):this._initialState=t,this},d.prototype.serializeRequests=function(){var t=null;return this._ddlPopupVisualizations.concat(this._ddlVisualizations).forEach(function(i){i.hasSelection()&&(t||(t={}),t[i.id]=i.reverseMappedSelection())}),t},d});