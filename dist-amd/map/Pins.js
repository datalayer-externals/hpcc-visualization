!function(t,e){"function"==typeof define&&define.amd?define(["d3","./Layer","./Utility","../common/Palette","../common/Utility","../api/ITooltip","css!./Pins"],e):t.map_Pins=e(t.d3,t.map_Layer,t.map_Utility,t.common_Palette,t.common_Utility,t.api_ITooltip)}(this,function(t,e,i,n,o,l){function r(){e.call(this),o.SimpleSelectionMixin.call(this),this._geohash=new i.Geohash}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype._class+=" map_Pins",r.prototype.mixin(o.SimpleSelectionMixin),r.prototype["implements"](l.prototype),r.prototype.publish("geohashColumn",null,"set","Geohash column",function(){return this.columns()},{optional:!0}),r.prototype.publish("tooltipColumn",null,"set","Tooltip column",function(){return this.columns()},{optional:!0}),r.prototype.publish("opacity",1,"number","Opacity",null,{tags:["Advanced"]}),r.prototype.publish("fillColor","#00FFDD","html-color","Pin Color",null,{optional:!0}),r.prototype.publish("strokeWidth",.5,"number","Pin Border Thickness (pixels)",null,{tags:["Basic"]}),r.prototype.publish("strokeColor",null,"html-color","Pin Border Color",null,{optional:!0}),r.prototype.publish("fontSize",18,"number","Font Size",null,{tags:["Basic","Shared"]}),r.prototype.publish("fontFamily","Verdana","string","Font Name",null,{tags:["Basic","Shared","Shared"]}),r.prototype.publish("fontColor","#000000","html-color","Font Color",null,{tags:["Basic","Shared"]}),r.prototype.publish("pinType","pin","set","Pin Type",["pin","circle","rectangle","rectangle-pin"],{tags:["Basic"]}),r.prototype.publish("arrowWidth",8,"number","Pin arrow width (pixels)",null,{tags:["Basic"],disable:function(t){return-1===["pin","rectangle-pin"].indexOf(t.pinType())}}),r.prototype.publish("arrowHeight",12,"number","Pin arrow height (pixels)",null,{tags:["Basic"],disable:function(t){return-1===["pin","rectangle-pin"].indexOf(t.pinType())}}),r.prototype.publish("pinWidth",20,"number","Width of pin (pixels)",null,{tags:["Basic"],disable:function(t){return-1===["rectangle","rectangle-pin"].indexOf(t.pinType())}}),r.prototype.publish("pinHeight",20,"number","Height of pin (pixels) (not including arrow)",null,{tags:["Basic"],disable:function(t){return-1===["rectangle","rectangle-pin"].indexOf(t.pinType())}}),r.prototype.publish("cornerRadius",10,"number","Radius of rectangular pin corners (pixels)",null,{tags:["Basic"],disable:function(t){return-1===["rectangle","rectangle-pin"].indexOf(t.pinType())}}),r.prototype.publish("pinRadius",12,"number","Radius of circle (pixels)",null,{tags:["Basic"],disable:function(t){return"circle"!==t.pinType()}}),r.prototype.publish("textBaseline","central","set","Pin text vertical alignment",["auto","use-script","no-change","reset-size","ideographic","alphabetic","hanging","mathematical","central","middle","text-after-edge","text-before-edge","inherit"],{tags:["Basic"]}),r.prototype.publish("omitNullLatLong",!1,"boolean","Remove lat=0,lng=0 from pinsData",null,{tags:["Basic"]}),r.prototype.pinsData=function(){var t=this._db.fieldByLabel(this.geohashColumn()),e=this._db.fieldByLabel(this.tooltipColumn()),i=this;return this.data().filter(function(t){return i.omitNullLatLong()&&0===t[0]&&0===t[1]?!1:!0}).map(function(i){var n={lat:i[0],"long":i[1],ext:i[2]instanceof Object?i[2]:{},origRow:i};if(t)try{var o=this._geohash.bounds(i[t.idx]);n.lat=(o.ne.lat+o.sw.lat)/2,n["long"]=(o.ne.lon+o.sw.lon)/2}catch(l){}return e&&(n.ext.tooltip=i[e.idx]),n},this)},r.prototype.layerEnter=function(i,n,o){e.prototype.layerEnter.apply(this,arguments),this._pinsTransform=n,this._selection.widgetElement(this._pinsTransform),this.pinsPaths=t.select(null),this.tooltipHTML(function(t){return void 0===t.ext.tooltip?"":t.ext.tooltip})},r.prototype.layerUpdate=function(t){e.prototype.layerUpdate.apply(this,arguments),this._pinsTransform.style("opacity",this.opacity()),this.pinsPaths=this._pinsTransform.selectAll(".pin").data(this.visible()?this.pinsData():[]);var i=this,n=this.pinsPaths.enter().append("g").attr("class","pin").call(this._selection.enter.bind(this._selection)).on("click",function(t){i.click(i.rowToObj(t.origRow),"geohash",i._selection.selected(this))}).on("dblclick",function(t){i.dblclick(i.rowToObj(t[2].origRow),"geohash",i._selection.selected(this))}).on("mouseover",function(t){i.isIE||this.parentNode.appendChild(this)}).on("mouseout.tooltip",function(t){t.ext&&t.ext.tooltip&&i.tooltip.hide.apply(this,arguments)}).on("mousemove.tooltip",function(t){t.ext&&t.ext.tooltip&&i.tooltip.show.apply(this,arguments)});n.append("path").attr("class","data").append("title"),n.append("text").attr("text-anchor","middle"),this.pinsPaths.selectAll("text").style("stroke",this.fontColor()).style("fill",this.fontColor()).style("font-size",this.fontSize()).style("font-family",this.fontFamily()).style("dominant-baseline",this.textBaseline()).attr("dx",0).attr("dy",this.pinTextDY()).text(function(t){return t.ext&&t.ext.text?t.ext.text:""});var o=this.svgPinPath();this.pinsPaths.selectAll("path.data").attr("d",o).attr("stroke-width",this.strokeWidth()+"px").style("display",function(e){var i=t.project(e.lat,e["long"]);return i?null:"none"}).style("stroke",function(t){return t.ext&&t.ext.strokeColor?t.ext.strokeColor:i.strokeColor()}).style("fill",function(t){return t.ext&&t.ext.fillColor?t.ext.fillColor:i.fillColor()}),this.pinsPaths.exit().remove()},r.prototype.layerZoomed=function(t){e.prototype.layerZoomed.apply(this,arguments),this.pinsPaths.attr("transform",function(e){var i=t.project(e.lat,e["long"]);return i||(i=[0,0]),"translate("+i[0]+", "+i[1]+")scale(1)"})},r.prototype.pinTextDY=function(){switch(this.pinType()){case"pin":case"rectangle-pin":return-this.arrowHeight();case"circle":case"rectangle":return 0}},r.prototype.svgPinPath=function(){switch(this.pinType()){case"pin":return this.circlePinPath();case"circle":return this.circlePath();case"rectangle":return this.rectanglePath();case"rectangle-pin":return this.rectanglePinPath()}},r.prototype.rectanglePinPath=function(){var t=this.pinWidth(),e=this.pinHeight(),i=this.cornerRadius(),n=this.arrowHeight(),o=this.arrowWidth(),l=0-t/2,r=0-e+i,s=(t-2*i-o)/2;return"M"+l+","+r+"a"+-i+","+-i+" 0 0 1 "+i+","+-i+"h"+(t+2*-i)+"a"+i+","+i+" 0 0 1 "+i+","+i+"v"+(e+2*-i)+"a"+i+","+i+" 0 0 1 "+-i+","+i+"h"+-s+"l"+-o/2+","+n+"l"+-o/2+","+-n+"h"+-s+"a"+-i+","+-i+" 0 0 1 "+-i+","+-i+"z"},r.prototype.rectanglePath=function(){var t=this.pinWidth(),e=this.pinHeight(),i=this.cornerRadius(),n=-t/2,o=-e/2;return o+=i,"M"+n+","+o+"a"+-i+","+-i+" 0 0 1 "+i+","+-i+"h"+(t+2*-i)+"a"+i+","+i+" 0 0 1 "+i+","+i+"v"+(e+2*-i)+"a"+i+","+i+" 0 0 1 "+-i+","+i+"h"+(-t+2*i)+"a"+-i+","+-i+" 0 0 1 "+-i+","+-i+"z"},r.prototype.circlePinPath=function(){var t=this.arrowHeight(),e=this.arrowWidth(),i=0-e/2,n=0-t,o=e/2,l=t,r=-o,s=-l,a=e+o,p=s,c=e,h=0;return"M"+i+","+n+"c"+r+" "+s+", "+a+" "+p+", "+c+" "+h+"l"+-e/2+","+t+"l"+-e/2+","+-t+"z"},r.prototype.circlePath=function(){var t=this.pinRadius(),e=t/2,i=0,n=t/2,o=t/2;return"M"+e+","+i+"a "+n+" "+o+" 0 1 0 0 0.01 0z"},r.prototype.click=function(t,e,i){console.log("Click:  "+JSON.stringify(t)+", "+e+", "+i)},r.prototype.dblclick=function(t,e,i){console.log("Double click:  "+JSON.stringify(t)+", "+e+", "+i)},r});