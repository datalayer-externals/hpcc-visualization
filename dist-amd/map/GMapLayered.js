!function(e,t){"function"==typeof define&&define.amd?define(["d3","./GMap","../common/SVGWidget"],t):e.map_GMapLayered=t(e.d3,e.map_GMap,e.common_SVGWidget)}(this,function(e,t,r){function o(){r.call(this),this._drawStartPos="origin"}function a(){t.call(this),this._layers=[]}var n=1/16,i=4096;return o.prototype=Object.create(r.prototype),o.prototype.constructor=o,o.prototype._class+=" map_Layered map_GMapLayered",o.prototype.enter=function(t,o){r.prototype.enter.apply(this,arguments),this._zoom=e.behavior.zoom().translate([0,0]).scale(1),this._d3GeoProjection=e.geo.mercator().scale(i/2/Math.PI).translate([0,0]),this._d3GeoPath=e.geo.path().projection(this._d3GeoProjection)},o.prototype.update=function(e,t){r.prototype.update.apply(this,arguments),this._hasZoomed=!0,this._hasRendered?this.zoomed():this.fullRender()},o.prototype.preRender=function(e){return Promise.all(this.gmap.layers().filter(function(e){return e.visible()}).map(function(e){return e.layerPreRender()}))},o.prototype.fullRender=function(){if(this._hasZoomed){this._hasRendered=!0,this.size(this.gmap.size());var t=this._element.selectAll(".layerContainer").data(this.gmap.layers().filter(function(e){return e.visible()}),function(e){return e.id()}),r=this;t.enter().append("g").attr("class","layerContainer").each(function(t){var o=e.select(this),a=r._parentOverlay.append("div");t.layerEnter(r,o,a)}),t.each(function(e){e.layerUpdate(r)}),t.exit().each(function(e){e.layerExit(r)}).remove(),this.zoomed()}},o.prototype.zoomed=function(){var e=this.gmap._overlay.getProjection();if(e){var t=new google.maps.LatLng(0,0),r=e.fromLatLngToDivPixel(t),o=parseFloat(this.surface.widgetX()),a=parseFloat(this.surface.widgetY()),i=[r.x-o,r.y-a],p=this.gmap._googleMap.getZoom();this._zoom.scale(n*(1<<p)).translate(i);var s=this._element.selectAll(".layerContainer"),c=this;s.each(function(e){e.layerZoomed(c)})}},o.prototype.projection=function(){return"mercator"},o.prototype.project=function(e,t){var r=this.surface.project(e,t);return[r.x,r.y]},a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype._class+=" map_GMapLayered",a.prototype.updateCircles=function(){},a.prototype.updatePins=function(){},a.prototype.layers=function(e){return arguments.length?(this._layers=e,this):this._layers},a.prototype.enter=function(){t.prototype.enter.apply(this,arguments),this.layered=new o,this.layered.gmap=this,this.layered.surface=this._viewportSurface,this.layered.surface.widget(this.layered).render()},a.prototype.render=function(e){var r=this,o=t.prototype.render.call(this,function(t){r.layered.preRender().then(function(){r.layered.fullRender(),e&&e(t)})});return o},a});