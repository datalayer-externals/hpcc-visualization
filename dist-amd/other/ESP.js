!function(e,t){"function"==typeof define&&define.amd?define(["./Comms","../common/Utility"],t):e.other_ESP=t(e.other_Comms,e.common_Utility)}(this,function(e,t){function n(e){if(e.Row&&e.Row instanceof Array)return e.Row.map(n);if(e instanceof Object)for(var t in e)e[t]=n(e[t]);return e}function r(){e.Basic.call(this)}function o(e){r.call(this),this.url(e+"WsWorkunits/")}function u(e,t){r.call(this),this.url(e+"WsWorkunits/"),this._wuid=t}function s(e,t,n){r.call(this),this.url(e+"WUResult.json"),this._wuid=t,this._name=n,this._xmlSchema=null}function i(e,t){r.call(this),this.url(e+"WUResult.json"),this._logicalName=t,this._xmlSchema=null}function a(e,t){r.call(this);var n=e.split("/"),o=n.pop();"json"===o.toLowerCase()&&(o=n.pop()),this._queryName=o,this._resultName=t,this.url(n.join("/")+"/"+o+"/json")}function l(e){return e&&e.replace?e.replace(/ +$/,""):e}function p(e,t){return e.filter(function(e){for(var n in t)if(void 0!==e[n]&&l(t[n])!==l(e[n]))return!1;return!0})}function c(e){for(var t in e){if(e[t].Row&&e[t].Row instanceof Array)return e;var n=c(e[t]);if(n)return n}return null}function f(t,n,r){var o=(new e.ESPUrl).url(t);return 0===n.indexOf("http")?new a(n,r):0===n.indexOf("~")||n.indexOf("::")>=0?new i(o.getUrl({pathname:"WsWorkunits/"}),n):n?new s(o.getUrl({pathname:"WsWorkunits/"}),n,r):null}var h=!1,m={};return r.prototype=Object.create(e.Basic.prototype),r.prototype.jsonp=function(t,n){var r=JSON.stringify(n);return h&&m[t]&&m[t][r]?Promise.resolve(m[t][r]):e.Basic.prototype.jsonp.apply(this,arguments).then(function(e){return h&&(m[t]||(m[t]={}),m[t][r]=e),e})},o.prototype=Object.create(r.prototype),o.prototype.wuQuery=function(e){var t=this.getUrl({pathname:"WsWorkunits/WUQuery.json"}),n={Wuid:"",Type:"",Cluster:"",RoxieCluster:"",Owner:"",State:"",StartDate:"",EndDate:"",ECL:"",Jobname:"",LogicalFile:"",LogicalFileSearchType:"",After:"",Before:"",Count:"",PageSize:100,PageStartFrom:0,PageEndAt:"",LastNDays:"",Sortby:"",Descending:0,CacheHint:""};for(var r in e)n[r]=e[r];return this.jsonp(t,n).then(function(e){return e.WUQueryResponse&&e.WUQueryResponse.Workunits?e.WUQueryResponse.Workunits.ECLWorkunit:[]})},u.prototype=Object.create(r.prototype),u.prototype.wuInfo=function(e){var t=this.getUrl({pathname:"WsWorkunits/WUInfo.json"}),n={Wuid:this._wuid,TruncateEclTo64k:!0,IncludeExceptions:!1,IncludeGraphs:!1,IncludeSourceFiles:!1,IncludeResults:!1,IncludeResultsViewNames:!1,IncludeVariables:!1,IncludeTimers:!1,IncludeResourceURLs:!1,IncludeDebugValues:!1,IncludeApplicationValues:!1,IncludeWorkflows:!1,IncludeXmlSchemas:!1,SuppressResultSchemas:!0};for(var r in e)n[r]=e[r];return this.jsonp(t,n).then(function(r){if(h){var o={WUInfoResponse:{Workunit:{}}};for(var u in e){var s=u.substring(7);o.WUInfoResponse.Workunit[s]=r.WUInfoResponse.Workunit[s]}m[t][JSON.stringify(n)]=o}return r})},u.prototype.wuUpdate=function(e){var t=this.getUrl({pathname:"WsWorkunits/WUUpdate.json"}),n={Wuid:this._wuid};for(var r in e)n[r]=e[r];return this.post(t,n)},u.prototype.appData=function(e,t,n){return 2===arguments.length?this.wuInfo({IncludeApplicationValues:!0}).then(function(n){var r;return n.WUInfoResponse&&n.WUInfoResponse.Workunit&&n.WUInfoResponse.Workunit.ApplicationValues&&n.WUInfoResponse.Workunit.ApplicationValues.ApplicationValue&&n.WUInfoResponse.Workunit.ApplicationValues.ApplicationValue.filter(function(n){return n.Application===e&&n.Name===t}).forEach(function(e){r=e.Value}),r}):3===arguments.length?this.wuUpdate({"ApplicationValues.ApplicationValue.0.Application":e,"ApplicationValues.ApplicationValue.0.Name":t,"ApplicationValues.ApplicationValue.0.Value":n,"ApplicationValues.ApplicationValue.itemcount":1}):void 0},u.prototype.results=function(){var e=this;return this.wuInfo({IncludeResults:!0}).then(function(n){var r=[];return t.exists("WUInfoResponse.Workunit.Results.ECLResult",n)&&(r=n.WUInfoResponse.Workunit.Results.ECLResult.map(function(t){return new s(e.getUrl({pathname:"WsWorkunits/"}),e._wuid,t.Name)})),r})},u.prototype.result=function(e,t){return e=e||this._wuid,f(e,t)},s.prototype=Object.create(r.prototype),s.prototype.wuid=function(e){return arguments.length?(this._wuid=e,this):this._wuid},s.prototype.name=function(e){return arguments.length?(this._name=e,this):this._name},s.prototype.query=function(e,t){e=e||{},t=t||{};var r={Wuid:this._wuid,ResultName:this._name,SuppressXmlSchema:!0,Start:0,Count:-1};for(var o in e)r[o]=e[o];var u=0;for(var s in t)r["FilterBy.NamedValue."+u+".Name"]=s,r["FilterBy.NamedValue."+u+".Value"]=t[s],++u;u&&(r["FilterBy.NamedValue.itemcount"]=u);var i=this;return this.jsonp(this.url(),r).then(function(e){return e.WUResultResponse&&e.WUResultResponse.Result&&e.WUResultResponse.Result[i._name]?(h&&(m[i.url()][JSON.stringify(r)]={WUResultResponse:{Result:e.WUResultResponse.Result}}),i._xmlSchema=e.WUResultResponse.Result.XmlSchema,n(e.WUResultResponse.Result[i._name])):[]})},i.prototype=Object.create(r.prototype),i.prototype.query=function(e,t){e=e||{},t=t||{};var r={Cluster:"hthor",LogicalName:this._logicalName,SuppressXmlSchema:null!==this._xmlSchema,Start:0,Count:-1};for(var o in e)r[o]=e[o];var u=0;for(var s in t)r["FilterBy.NamedValue."+u+".Name"]=s,r["FilterBy.NamedValue."+u+".Value"]=t[s],++u;u&&(r["FilterBy.NamedValue.itemcount"]=u);var i=this;return this.jsonp(this.url(),r).then(function(e){return e.WUResultResponse&&e.WUResultResponse.Result&&e.WUResultResponse.Result.Row?(i._xmlSchema=e.WUResultResponse.Result.XmlSchema,n(e.WUResultResponse.Result.Row)):[]})},a.prototype=Object.create(r.prototype),a.prototype.query=function(e,t){e=e||{},t=t||{};var r={};for(var o in e)r[o]=e[o];for(var u in t)r[u]=t[u];var s=this;return this.jsonp(this.url(),r).then(function(e){if(e=c(e))if(s._resultName){if(e&&e[s._resultName]&&e[s._resultName].Row)return n(p(e[s._resultName].Row,t))}else for(var r in e)if(e[r].Row)return n(p(e[r].Row,t));return[]})},{enableCache:function(e){return arguments.length?(h=e,e||(m={}),this):h},cache:function(e){return arguments.length?(m=e,this):m},WsWorkunits:o,Workunit:u,WUResult:s,createConnection:function(t){t=t||document.URL;var n=(new e.ESPUrl).url(t);if(n.isWsWorkunits()){var r=e.createESPConnection(t);if(r instanceof e.WsWorkunits&&r.wuid())return new u(r.getUrl({pathname:""}),r.wuid()).url(t)}return null},createResult:f,flattenResult:function(e,t){var n={columns:[],data:[]};if(e&&e.length){var r={};if(t&&t.length)t.forEach(function(e){r[e.value.toLowerCase()]=n.columns.length,n.columns.push(e.key)});else for(var o in e[0])r[o.toLowerCase()]=n.columns.length,n.columns.push(o);e.forEach(function(e,t){var o=[];for(var u in e)void 0!==r[u.toLowerCase()]&&(o[r[u.toLowerCase()]]=e[u]);n.data.push(o)})}return n}}});