!function(e,i){"function"==typeof define&&define.amd?define(["../common/Utility","../common/Platform"],i):e.other_Persist=i(e.common_Utility,e.common_Platform)}(this,function(e,i){function t(e){return e.publishedProperties(!1,!0)}function r(e,i){e&&(i(e),t(e).forEach(function(t){switch(t.type){case"widget":r(e[t.id](),i);break;case"widgetArray":case"propertyArray":a(e[t.id](),i)}}))}function a(e,i){e&&e.forEach(function(e){r(e,i)})}function o(e,i,t){e.propertyWalker(i,t)}function n(e,i,t){r(e,function(e){o(e,i,t)})}function s(i,t){if(t=t&&"1.14.2-dev"!==t?t:"1.18.0",!i.__version)return i;var r=e.parseVersionString(i.__version),a=e.parseVersionString(t);if(1===r.major&&14===r.minor){console.log("Upgrading old persist from "+i.__version+" to "+t);var o=JSON.stringify(i);o=o.split('"'+i.__version).join('"'+t);var n=JSON.parse(o);return n.__properties&&n.__properties.content&&n.__properties.content.forEach(function(e){JSON.stringify(e).split("graph_Graph").length>1&&a.minor>=16&&(e.__properties.widget.__id=e.__properties.widget.__properties.widget.__id,e.__properties.widget.__class="composite_MegaChart",e.__properties.widget.__properties.showCSV=!1,e.__properties.widget.__properties.chartType="GRAPH",e.__properties.widget.__properties.chart=e.__properties.widget.__properties.widget,delete e.__properties.widget.__properties.chart.__id,delete e.__properties.widget.__properties.widget),"undefined"==typeof e.__properties.fields&&(e.__properties.fields=[])}),n}return i}return{discover:t,widgetWalker:r,widgetArrayWalker:a,propertyWalker:o,widgetPropertyWalker:n,serializeTheme:function(e,i){return JSON.stringify(this.serializeThemeToObject(e,i))},serializeThemeToObject:function(e,i){function t(e,i){var t=!1;for(var r in i)if(-1!==e.indexOf(i[r])){t=!0;break}return t}i=i||["surface","Color","Font","palette"];var r={};return n(e,null,function(e,a){if((e[a.id+"_modified"]()||e.publishedProperty(a.id).origDefaultValue!==e.publishedProperty(a.id).defaultValue)&&t(a.id,i)){var o=e._class.trim().split(" ");for(var n in o){if(void 0===r[o[n]]&&(r[o[n]]={}),void 0===r[o[n]][a.id]){r[o[n]][a.id]=e[a.id]();break}if(r[o[n]][a.id]===e[a.id]())break}}}),r},removeTheme:function(e,i){n(e,null,function(e,i){e.publishedProperty(i.id).defaultValue=e.publishedProperty(i.id).origDefaultValue}),"function"==typeof i&&i.call(this)},applyTheme:function(e,i,t){var r=this;n(e,null,function(e,t){switch(t.type){case"widget":return r.applyTheme(e[t.id](),i),!0;case"widgetArray":var a=e[t.id]();return a.forEach(function(e){r.applyTheme(e,i)},this),!0;default:e.applyTheme(i)}}),"function"==typeof t&&t.call(this)},serializeToObject:function(e,i,t,r){var a={__class:e.classID()};0!==e._id.indexOf(e._idSeed)&&(a.__id=e._id),e.version&&(a.__version=e.version()),a.__properties={};var n=this;if(o(e,i,function(i,o){if(i[o.id+"_modified"]())switch(o.type){case"widget":return a.__properties[o.id]=n.serializeToObject(i[o.id](),null,t,r&&!e.serializeState),!0;case"widgetArray":case"propertyArray":a.__properties[o.id]=[];var s=i[o.id]();return s.forEach(function(i,s){a.__properties[o.id].push(n.serializeToObject(i,null,t,r&&!e.serializeState))}),!0;default:a.__properties[o.id]=i[o.id]()}}),"marshaller_Graph"===e.classID()){var s=e.data().vertices;s&&(this.__vertices=s.map(function(i){return this.serializeToObject(i,null,t,r&&!e.serializeState)},this))}return t&&e.data&&(a.__data||(a.__data={}),a.__data.data=e.data()),r&&(e.serializeState?a.__state=e.serializeState():e.data&&(a.__state={data:e.data()})),a},serialize:function(e,i,t,r){return JSON.stringify(this.serializeToObject(e,i,t,r))},deserializeFromObject:function(e,i,t){var r=this;return new Promise(function(a,o){var s=0;n(e,null,function(e,t){if(e[t.id+"_reset"](),void 0!==i.__properties[t.id])switch(t.type){case"widget":++s;var a=t.id;r.create(i.__properties[t.id],function(i){e[a](i),--s});break;case"widgetArray":case"propertyArray":var o=t.id,n=i.__properties[t.id];if(n.length){++s;var d=[];d.length=n.length;var _=0;n.forEach(function(i,t){++_,r.create(i,function(i){i._owner=e,d[t]=i,--_});var a=setInterval(function(){0>=_&&(clearInterval(a),_=void 0,e[o](d),--s)},20)})}break;default:e[t.id](i.__properties[t.id])}});var d=setInterval(function(){if(0>=s){if(clearInterval(d),s=void 0,i.__data)for(var r in i.__data)switch(r){case"data":e.data(i.__data[r]);break;default:console.log("Unexpected __data item:  "+r),e[r](i.__data[r])}i.__state&&(e.deserializeState?e.deserializeState(i.__state):i.__state.data&&e.data&&e.data(i.__state.data)),t&&(console.log("Deprecated:  callback, use promise (Persist.deserializeFromObject)"),t(e)),a(e)}},20)})},deserialize:function(e,i,t){"string"==typeof i&&(i=JSON.parse(i)),i.__id&&0!==i.__id.indexOf(e._idSeed)&&e._id!==i.__id&&console.log("Deserialize:  IDs do not match - "+e._id),this.deserializeFromObject(e,i,t)},create:function(t,r){"string"==typeof t&&(t=JSON.parse(t)),t=s(t,(new i).version());var a=this;return e.requireWidget(t.__class).then(function(e){var i=new e;return t.__id&&0!==t.__id.indexOf(i._idSeed)&&0!==t.__id.indexOf("_pe")&&(i._id=t.__id),a.deserializeFromObject(i,t,r)})["catch"](function(e){console.log("Persist.create:  ***exception***"),console.log(e),r&&(console.log("Deprecated:  callback, use promise (Persist.create)"),r(null))})},clone:function(e,i){this.create(this.serializeToObject(e,[],!0,!0),i)}}});